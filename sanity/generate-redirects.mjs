#!/usr/bin/env node

/**
 * Generate redirect documents in Sanity from the WP redirect map.
 *
 * Usage:
 *   node sanity/generate-redirects.mjs              # create redirects
 *   node sanity/generate-redirects.mjs --dry-run    # preview only
 *
 * Prerequisites:
 *   - sanity/wp-redirect-map.json must exist (generated by migrate-wp-posts.mjs)
 */

import { createClient } from "@sanity/client";
import { readFileSync, existsSync } from "fs";
import { randomUUID } from "crypto";
import path from "path";

const DRY_RUN = process.argv.includes("--dry-run");
const MAP_FILE = path.resolve("sanity/wp-redirect-map.json");

const sanityClient = createClient({
  projectId: process.env.PUBLIC_SANITY_PROJECT_ID || "ypmt1bmc",
  dataset: process.env.PUBLIC_SANITY_DATASET || "production",
  apiVersion: "2024-01-01",
  token: process.env.SANITY_WRITE_TOKEN,
  useCdn: false,
});

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}

async function main() {
  if (!existsSync(MAP_FILE)) {
    console.error(`Missing ${MAP_FILE}. Run migrate-wp-posts.mjs first.`);
    process.exit(1);
  }

  const redirectMap = JSON.parse(readFileSync(MAP_FILE, "utf-8"));
  const entries = Object.values(redirectMap);

  console.log(`\n=== Generating ${entries.length} redirect documents${DRY_RUN ? " [DRY RUN]" : ""} ===\n`);

  const existing = await sanityClient.fetch(
    `*[_type == "redirect"]{ fromPath }`
  );
  const existingPaths = new Set(existing.map((r) => r.fromPath));
  console.log(`  Existing redirects in Sanity: ${existingPaths.size}`);

  const toCreate = entries.filter((e) => !existingPaths.has(e.fromPath));
  console.log(`  New redirects to create: ${toCreate.length}\n`);

  if (DRY_RUN) {
    for (const entry of toCreate.slice(0, 10)) {
      console.log(`  ${entry.fromPath} â†’ ${entry.toPath}`);
    }
    if (toCreate.length > 10) {
      console.log(`  ... and ${toCreate.length - 10} more`);
    }
    console.log("\n  Done (dry run). No changes were made.");
    return;
  }

  let created = 0;
  for (const entry of toCreate) {
    await sanityClient.create({
      _type: "redirect",
      fromPath: entry.fromPath,
      toPath: entry.toPath,
      statusCode: 301,
      isActive: true,
      note: "WordPress migration",
    });
    created++;
    if (created % 50 === 0) {
      console.log(`  [${created}/${toCreate.length}] Created...`);
    }
    await sleep(100);
  }

  console.log(`\n  Done! Created ${created} redirect documents.`);
}

main().catch((err) => {
  console.error("Fatal error:", err);
  process.exit(1);
});
