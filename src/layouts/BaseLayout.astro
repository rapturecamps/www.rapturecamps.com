---
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import ContactWidget from "@/components/layout/ContactWidget.astro";
import CookieBanner from "@/components/layout/CookieBanner.astro";
import ExitIntentPopup from "@/components/popups/ExitIntentPopup.astro";
import SpinningWheelPopup from "@/components/popups/SpinningWheelPopup.astro";
import SpecialOfferPopup from "@/components/popups/SpecialOfferPopup.astro";
import { matchPopupForPath } from "@/lib/sanity-data";
import "@/styles/globals.css";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  bookingUrl?: string;
  /** Disable all popups on this page (e.g. legal pages) */
  disablePopups?: boolean;
  /** Prevent search engines from indexing this page */
  noindex?: boolean;
  /** Preload a hero/LCP image for faster rendering */
  preloadImage?: string;
  /** SEO: link rel="prev" for paginated pages */
  prevPage?: string;
  /** SEO: link rel="next" for paginated pages */
  nextPage?: string;
  /** Translation metadata for building correct alternate-language URLs */
  translations?: { slug: string; language: string }[];
  /** Base path for building translated URLs (e.g. "/blog") */
  translationBasePath?: string;
}

const {
  title = "Rapture Surfcamps - Learn to Surf, Surf the World, Stay with Us!",
  description = "A network of 8 unique surf camps in 5 countries on 4 continents. Surf the world with Rapture in Bali, Costa Rica, Portugal, Morocco, and Nicaragua.",
  ogImage,
  bookingUrl,
  disablePopups = false,
  noindex = false,
  preloadImage,
  prevPage,
  nextPage,
  translations = [],
  translationBasePath,
} = Astro.props;

const siteUrl = import.meta.env.PUBLIC_SITE_URL || "https://www.rapturecamps.com";
const pathname = Astro.url.pathname;
const isDE = pathname.startsWith("/de/") || pathname === "/de";
const pathWithoutLang = isDE ? (pathname.replace(/^\/de/, "") || "/") : pathname;
const canonicalUrl = new URL(pathname, siteUrl);

function getTranslatedPath(lang: string): string {
  if (translations.length > 0 && translationBasePath) {
    const t = translations.find((tr) => tr?.language === lang);
    if (t) {
      const base = lang === "en" ? translationBasePath : `/de${translationBasePath}`;
      return `${base}/${t.slug}`;
    }
  }
  return lang === "en" ? pathWithoutLang : `/de${pathWithoutLang === "/" ? "/" : pathWithoutLang}`;
}

const enUrl = new URL(getTranslatedPath("en"), siteUrl);
const deUrl = new URL(getTranslatedPath("de"), siteUrl);
const alternatePathForHeader = isDE ? getTranslatedPath("en") : getTranslatedPath("de");
const defaultOgImage = `${siteUrl}/images/og-default.jpg`;
const resolvedOgImage = ogImage || defaultOgImage;

const currentLang = Astro.currentLocale ?? "en";
const activePopup = disablePopups ? null : await matchPopupForPath(pathname, currentLang);
const popupConfig = activePopup ? JSON.stringify({
  type: activePopup.popupType,
  trigger: activePopup.triggerMode || "timed",
  delay: activePopup.delaySeconds ?? 10,
  zohoListKey: activePopup.zohoListKey || "",
  zohoSource: activePopup.zohoSource || "",
}) : null;
---

<!doctype html>
<html lang={Astro.currentLocale ?? "en"}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/images/rapturecamps-logo.svg" />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="de" href={deUrl} />
    <link rel="alternate" hreflang="x-default" href={enUrl} />

    <title>{title}</title>
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Rapture Surfcamps" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={resolvedOgImage} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@rapturecamps" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={resolvedOgImage} />

    {prevPage && <link rel="prev" href={prevPage} />}
    {nextPage && <link rel="next" href={nextPage} />}
    <link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin />
    {preloadImage && <link rel="preload" as="image" href={preloadImage} fetchpriority="high" />}
  </head>
  <body class="font-sans antialiased bg-dark text-white" data-booking-url={bookingUrl}>
    <Header alternatePath={alternatePathForHeader} />
    <main>
      <slot />
    </main>
    <Footer lang={Astro.currentLocale ?? "en"} />
    <ContactWidget />
    <CookieBanner />

    {/* --- CMS-driven popup system --- */}
    {activePopup?.popupType === "exit-intent" && (
      <ExitIntentPopup
        headline={activePopup.headline}
        body={activePopup.body}
        ctaText={activePopup.ctaText}
        ctaHref={activePopup.ctaHref}
        voucherCode={activePopup.voucherCode}
      />
    )}
    {activePopup?.popupType === "spinning-wheel" && (
      <SpinningWheelPopup
        headline={activePopup.wheelHeadline}
        subheadline={activePopup.wheelSubheadline}
        segments={activePopup.segments}
      />
    )}
    {activePopup?.popupType === "special-offer" && (
      <SpecialOfferPopup
        headline={activePopup.headline}
        body={activePopup.body}
        ctaText={activePopup.ctaText}
        ctaHref={activePopup.ctaHref}
        image={activePopup.offerImageUrl}
        voucherCode={activePopup.voucherCode}
        expiresAt={activePopup.expiresAt}
      />
    )}

    {popupConfig && (
      <script is:inline id="popup-manager-script" data-config={popupConfig}>
      (function () {
        var script = document.getElementById("popup-manager-script");
        if (!script) return;
        var raw = script.getAttribute("data-config");
        if (!raw) return;

        var config;
        try { config = JSON.parse(raw); } catch (e) { return; }

        var SESSION_KEY = "rc_popup_shown";
        if (sessionStorage.getItem(SESSION_KEY)) return;

        function firePopup(type) {
          sessionStorage.setItem(SESSION_KEY, type);
          window.dispatchEvent(new CustomEvent("rc:show-popup", { detail: { type: type, zohoListKey: config.zohoListKey, zohoSource: config.zohoSource } }));
        }

        var trigger = config.trigger || "timed";
        var delay = (config.delay || 10) * 1000;
        var type = config.type;

        if (trigger === "timed") {
          setTimeout(function () { firePopup(type); }, delay);
          return;
        }

        if (trigger === "exit-intent") {
          var exitFired = false;
          function onExit() {
            if (exitFired || sessionStorage.getItem(SESSION_KEY)) return;
            exitFired = true;
            firePopup(type);
          }
          document.addEventListener("mouseleave", function (e) { if (e.clientY <= 0) onExit(); });
          setTimeout(onExit, delay || 45000);
          return;
        }

        if (trigger === "timed-or-exit") {
          var fired = false;
          function fire() {
            if (fired || sessionStorage.getItem(SESSION_KEY)) return;
            fired = true;
            firePopup(type);
          }
          setTimeout(fire, delay);
          document.addEventListener("mouseleave", function (e) { if (e.clientY <= 0) fire(); });
        }
      })();
      </script>
    )}

    <script is:inline>
      (function () {
        var hdr = document.getElementById("main-header");
        var btn = document.getElementById("menu-toggle");
        var menu = document.getElementById("mobile-menu");
        var iconMenu = document.getElementById("icon-menu");
        var iconClose = document.getElementById("icon-close");
        if (!hdr || !btn || !menu || !iconMenu || !iconClose) return;

        var menuOpen = false;

        function openMenu() {
          menuOpen = true;
          menu.classList.remove("hidden");
          iconMenu.classList.add("hidden");
          iconClose.classList.remove("hidden");
          hdr.setAttribute("data-open", "true");
          document.body.style.overflow = "hidden";
        }

        function closeMenu() {
          menuOpen = false;
          menu.classList.add("hidden");
          iconMenu.classList.remove("hidden");
          iconClose.classList.add("hidden");
          hdr.removeAttribute("data-open");
          document.body.style.overflow = "";
        }

        btn.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          if (menuOpen) { closeMenu(); } else { openMenu(); }
        });

        menu.querySelectorAll("a").forEach(function (link) {
          link.addEventListener("click", function () { closeMenu(); });
        });

        /* --- Desktop destinations dropdown --- */
        var destTrigger = document.getElementById("dest-trigger");
        var destPanel = document.getElementById("dest-panel");
        var destChevron = document.getElementById("dest-chevron");
        var destBtn = document.getElementById("dest-btn");

        if (destTrigger && destPanel && destChevron) {
          var dropdownOpen = false;
          var closeTimer = null;

          function showDropdown() {
            if (closeTimer) { clearTimeout(closeTimer); closeTimer = null; }
            dropdownOpen = true;
            destPanel.classList.add("is-open");
            destChevron.classList.add("is-open");
            hdr.setAttribute("data-dropdown", "true");
          }

          function hideDropdown() {
            dropdownOpen = false;
            destPanel.classList.remove("is-open");
            destChevron.classList.remove("is-open");
            hdr.removeAttribute("data-dropdown");
          }

          function scheduleClose() {
            closeTimer = setTimeout(hideDropdown, 150);
          }

          destTrigger.addEventListener("mouseenter", showDropdown);
          destTrigger.addEventListener("mouseleave", scheduleClose);

          destBtn.addEventListener("click", function (e) {
            e.preventDefault();
            if (dropdownOpen) { hideDropdown(); } else { showDropdown(); }
          });

          destPanel.querySelectorAll("a").forEach(function (link) {
            link.addEventListener("click", hideDropdown);
          });

          document.addEventListener("keydown", function (e) {
            if (e.key === "Escape" && dropdownOpen) hideDropdown();
          });
        }

        /* --- Mobile country accordions --- */
        var countryBtns = menu.querySelectorAll(".mobile-country-btn");
        countryBtns.forEach(function (cbtn) {
          cbtn.addEventListener("click", function (e) {
            e.preventDefault();
            var parent = cbtn.closest(".mobile-country");
            var camps = parent.querySelector(".mobile-country-camps");
            var chevron = parent.querySelector(".mobile-country-chevron");
            var isOpen = !camps.classList.contains("hidden");

            if (isOpen) {
              camps.classList.add("hidden");
              chevron.classList.remove("is-open");
            } else {
              camps.classList.remove("hidden");
              chevron.classList.add("is-open");
            }
          });
        });

        /* --- Context-aware Book button --- */
        var contextBookingUrl = document.body.getAttribute("data-booking-url");
        if (contextBookingUrl) {
          document.querySelectorAll(".book-link").forEach(function (link) {
            link.setAttribute("href", contextBookingUrl);
          });
        }

        /* --- Scroll detection --- */
        var scrolled = false;
        function onScroll() {
          var shouldBeScrolled = window.scrollY > 50;
          if (shouldBeScrolled !== scrolled) {
            scrolled = shouldBeScrolled;
            if (scrolled) {
              hdr.setAttribute("data-scrolled", "true");
            } else {
              hdr.removeAttribute("data-scrolled");
            }
          }
        }
        window.addEventListener("scroll", onScroll, { passive: true });
        onScroll();
      })();
    </script>
  </body>
</html>
