---
interface Season {
  name: string;
  startMonth: number;
  endMonth: number;
  waveConsistency: number;
  waveSize?: string;
  crowdLevel?: number;
  bestFor?: string;
  color?: string;
  description?: string;
}

interface Props {
  block: {
    heading?: string;
    body?: any[];
    seasons?: Season[];
    airTemp?: { low?: number; high?: number };
    waterTemp?: { low?: number; high?: number };
    wetsuitNote?: string;
    background?: string;
  };
}

const { block } = Astro.props;
const bg = block.background === "dark-lighter" ? "bg-dark-lighter" : "bg-dark";
const heading = block.heading || "Best Time to Surf";
const body = block.body;
const seasons = block.seasons || [];
const airTemp = block.airTemp;
const waterTemp = block.waterTemp;
const wetsuitNote = block.wetsuitNote;

const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

const COLOR_MAP: Record<string, { bar: string; bg: string; text: string }> = {
  amber:  { bar: "bg-amber-400/50",  bg: "bg-amber-400/10",  text: "text-amber-400" },
  blue:   { bar: "bg-sky-400/50",    bg: "bg-sky-400/10",    text: "text-sky-400" },
  green:  { bar: "bg-green-400/50",  bg: "bg-green-400/10",  text: "text-green-400" },
  purple: { bar: "bg-purple-400/50", bg: "bg-purple-400/10", text: "text-purple-400" },
};

function monthInSeason(monthIdx: number, season: Season): boolean {
  const m = monthIdx + 1;
  if (season.startMonth <= season.endMonth) {
    return m >= season.startMonth && m <= season.endMonth;
  }
  return m >= season.startMonth || m <= season.endMonth;
}

function getSeasonForMonth(monthIdx: number): Season | undefined {
  return seasons.find((s) => monthInSeason(monthIdx, s));
}

const monthData = MONTHS.map((label, i) => {
  const season = getSeasonForMonth(i);
  return { label, season, consistency: season?.waveConsistency || 0, color: season?.color || "amber" };
});

const maxConsistency = Math.max(...monthData.map((m) => m.consistency), 1);

// Portable text → HTML (mirrors BlockRenderer's logic)
function renderSpans(children: any[], markDefs: any[] = []): string {
  if (!children) return "";
  return children.map((c: any) => {
    let t = c.text || "";
    for (const m of c.marks || []) {
      if (m === "strong") { t = `<strong>${t}</strong>`; continue; }
      if (m === "em") { t = `<em>${t}</em>`; continue; }
      const def = markDefs.find((d: any) => d._key === m);
      if (def?._type === "link") {
        const rel = def.blank ? ' target="_blank" rel="noopener"' : "";
        t = `<a href="${def.href}"${rel}>${t}</a>`;
      }
    }
    return t;
  }).join("");
}

function bodyToHtml(blocks: any[]): string {
  if (!Array.isArray(blocks)) return "";
  let html = "";
  let openList: string | null = null;
  for (const b of blocks) {
    if (b._type !== "block") continue;
    const text = renderSpans(b.children, b.markDefs);
    const style = b.style || "normal";
    const li = b.listItem;
    if (openList && (!li || li !== openList)) {
      html += openList === "bullet" ? "</ul>" : "</ol>";
      openList = null;
    }
    if (li) {
      if (!openList) {
        html += li === "bullet" ? '<ul class="list-disc pl-5 space-y-1.5">' : '<ol class="list-decimal pl-5 space-y-1.5">';
        openList = li;
      }
      html += `<li>${text}</li>`;
      continue;
    }
    if (style === "h3") html += `<h3 class="text-lg font-semibold text-white mt-6 mb-2">${text}</h3>`;
    else if (style === "h4") html += `<h4 class="text-base font-semibold text-white mt-4 mb-1">${text}</h4>`;
    else html += `<p>${text}</p>`;
  }
  if (openList) html += openList === "bullet" ? "</ul>" : "</ol>";
  return html;
}

const bodyHtml = body ? bodyToHtml(body) : "";
---

<section class:list={["py-16 sm:py-20", bg]}>
  <div class="px-6 sm:px-12 lg:px-20">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-16">
      <!-- Left: SEO text content -->
      <div>
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-white mb-6">{heading}</h2>
        {bodyHtml ? (
          <div class="text-base text-white/50 leading-relaxed space-y-4" set:html={bodyHtml} />
        ) : (
          <p class="text-base text-white/50 leading-relaxed">
            Explore the best seasons and conditions for surfing at this destination.
          </p>
        )}
      </div>

      <!-- Right: Visual chart -->
      <div class="lg:sticky lg:top-28">
        <div class="rounded-2xl border border-white/5 bg-dark-lighter/50 p-6">
          <!-- Legend (deduplicated by name) -->
          <div class="flex flex-wrap gap-3 mb-6">
            {[...new Map(seasons.map((s) => [s.name, s])).values()].map((season) => {
              const c = COLOR_MAP[season.color || "amber"];
              return (
                <span class="flex items-center gap-1.5 text-[10px] uppercase tracking-wider text-white/40">
                  <span class:list={["h-2 w-2 rounded-full", c.bar]}></span>
                  {season.name}
                </span>
              );
            })}
          </div>

          <!-- Wave consistency bars -->
          <p class="text-[10px] uppercase tracking-wider text-white/25 mb-3">Wave Consistency</p>
          <div class="flex items-end gap-1.5 mb-1" style="height: 144px">
            {monthData.map((m) => {
              const c = COLOR_MAP[m.color];
              const barH = m.consistency > 0 ? Math.max(36, Math.round((m.consistency / maxConsistency) * 144)) : 12;
              return (
                <div class="flex-1 group" style={`height: ${barH}px`}>
                  <div
                    class:list={["w-full h-full rounded-t transition-all group-hover:opacity-80", m.consistency > 0 ? c.bar : "bg-white/5"]}
                  ></div>
                </div>
              );
            })}
          </div>
          <div class="flex gap-1 mb-6">
            {monthData.map((m) => (
              <div class="flex-1 text-center">
                <span class="text-[9px] text-white/30">{m.label[0]}</span>
              </div>
            ))}
          </div>

          <!-- Season bands -->
          <p class="text-[10px] uppercase tracking-wider text-white/25 mb-2">Seasons</p>
          <div class="flex gap-0.5 h-6 rounded-lg overflow-hidden mb-6">
            {monthData.map((m) => {
              const c = m.season ? COLOR_MAP[m.color] : null;
              return (
                <div
                  class:list={["flex-1 flex items-center justify-center", c ? c.bar + " opacity-30" : "bg-white/5"]}
                  title={m.season ? `${m.label}: ${m.season.name}` : m.label}
                >
                  <span class="text-[8px] font-medium text-white/60">{m.label[0]}</span>
                </div>
              );
            })}
          </div>

          <!-- Crowd level -->
          {seasons.some((s) => s.crowdLevel) && (
            <div>
              <p class="text-[10px] uppercase tracking-wider text-white/25 mb-2">Crowd Level</p>
              <div class="flex gap-1 h-4 mb-6">
                {monthData.map((m) => {
                  const crowd = m.season?.crowdLevel || 0;
                  const opacity = crowd > 0 ? 0.15 + (crowd / 5) * 0.55 : 0.05;
                  return (
                    <div
                      class="flex-1 rounded-sm bg-white"
                      style={`opacity: ${opacity}`}
                      title={m.season ? `${m.label}: ${crowd}/5` : m.label}
                    ></div>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Temperature bars -->
          {(airTemp?.low != null || waterTemp?.low != null) && (
            <div>
              <p class="text-[10px] uppercase tracking-wider text-white/25 mb-3">Temperature</p>
              <div class="space-y-2">
                {airTemp?.low != null && airTemp?.high != null && (
                  <div class="flex items-center gap-3">
                    <span class="text-[10px] text-white/30 w-10 shrink-0">Air</span>
                    <div class="flex-1 h-2 rounded-full bg-white/5 relative overflow-hidden">
                      <div
                        class="absolute inset-y-0 rounded-full bg-gradient-to-r from-amber-400/40 to-amber-400/80"
                        style={`left: ${((airTemp.low - 10) / 30) * 100}%; right: ${100 - ((airTemp.high - 10) / 30) * 100}%`}
                      ></div>
                    </div>
                    <span class="text-[10px] text-white/30 shrink-0">{airTemp.low}–{airTemp.high}°C</span>
                  </div>
                )}
                {waterTemp?.low != null && waterTemp?.high != null && (
                  <div class="flex items-center gap-3">
                    <span class="text-[10px] text-white/30 w-10 shrink-0">Water</span>
                    <div class="flex-1 h-2 rounded-full bg-white/5 relative overflow-hidden">
                      <div
                        class="absolute inset-y-0 rounded-full bg-gradient-to-r from-sky-400/40 to-sky-400/80"
                        style={`left: ${((waterTemp.low - 10) / 30) * 100}%; right: ${100 - ((waterTemp.high - 10) / 30) * 100}%`}
                      ></div>
                    </div>
                    <span class="text-[10px] text-white/30 shrink-0">{waterTemp.low}–{waterTemp.high}°C</span>
                  </div>
                )}
              </div>
            </div>
          )}

          <!-- Wetsuit note -->
          {wetsuitNote && (
            <div class="mt-4 pt-4 border-t border-white/5 flex items-center gap-2 text-xs text-white/35">
              <svg class="h-3.5 w-3.5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
              <span>{wetsuitNote}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>
