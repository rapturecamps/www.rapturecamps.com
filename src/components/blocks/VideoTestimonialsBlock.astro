---
interface VideoItem {
  bunnyVideoId: string;
  posterImageUrl?: string;
  guestName?: string;
  date?: string;
  location?: string;
  quote?: string;
}

interface Props {
  block: {
    source?: string;
    heading?: string;
    headingOverride?: string;
    bunnyLibraryId?: string;
    bunnyPullZone?: string;
    videos?: VideoItem[];
    resolvedSet?: {
      heading?: string;
      bunnyLibraryId?: string;
      bunnyPullZone?: string;
      videos?: VideoItem[];
    };
    background?: string;
  };
}

const { block } = Astro.props;

const isLibrary = block.source === "library" && block.resolvedSet;
const set = isLibrary ? block.resolvedSet! : block;

const heading = (isLibrary ? block.headingOverride : null) || set.heading || "Stories from Our Guests";
const pullZone = set.bunnyPullZone || "";
const videos = (set.videos || []).filter((v) => v.bunnyVideoId);
const bgClass = block.background === "dark-lighter" ? "bg-dark-lighter" : "bg-dark";
---

{videos.length > 0 && (
  <section class:list={["py-16 sm:py-20", bgClass]}>
    <div class="px-6 sm:px-12 lg:px-20 mb-8 flex items-end justify-between gap-4">
      <div>
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-white">{heading}</h2>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <button
          class="vt-prev flex h-10 w-10 items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors"
          aria-label="Previous"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <button
          class="vt-next flex h-10 w-10 items-center justify-center rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors"
          aria-label="Next"
        >
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </button>
      </div>
    </div>

    <div class="vt-track relative">
      <div class="vt-slider flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory no-scrollbar">
        {videos.map((v, i) => {
          const poster = v.posterImageUrl
            || (pullZone && v.bunnyVideoId ? `https://${pullZone}/${v.bunnyVideoId}/thumbnail.jpg` : "");
          const videoSrc = pullZone && v.bunnyVideoId
            ? `https://${pullZone}/${v.bunnyVideoId}/play_720p.mp4`
            : "";

          return (
            <div
              class="vt-card group relative flex-shrink-0 w-[260px] sm:w-[280px] lg:w-[300px] snap-center rounded-2xl overflow-hidden cursor-pointer select-none"
              data-index={i}
              data-video-src={videoSrc}
            >
              <div class="relative aspect-[9/14]">
                {poster && (
                  <img
                    src={poster}
                    alt={`Video review by ${v.guestName || "Guest"}`}
                    class="vt-poster absolute inset-0 h-full w-full object-cover"
                    loading="lazy"
                  />
                )}

                {videoSrc && (
                  <video
                    class="vt-video absolute inset-0 h-full w-full object-cover opacity-0 transition-opacity duration-300"
                    preload="none"
                    loop
                    playsinline
                    poster={poster}
                  >
                    <source src={videoSrc} type="video/mp4" />
                  </video>
                )}

                {v.location && (
                  <div class="absolute top-4 left-4 z-20">
                    <span class="inline-block rounded-full bg-green-400 px-3 py-1 text-[10px] font-bold uppercase tracking-wider text-dark">
                      {v.location}
                    </span>
                  </div>
                )}

                <div class="vt-overlay absolute inset-0 z-10 flex flex-col justify-end transition-opacity duration-300">
                  <div class="bg-gradient-to-t from-dark/90 via-dark/40 to-transparent p-5 pt-24">
                    {v.quote && (
                      <p class="vt-quote text-lg sm:text-xl font-semibold text-white leading-snug mb-3 transition-all duration-300">
                        {v.quote}
                      </p>
                    )}
                    <div class="vt-meta flex items-center gap-2 transition-all duration-300">
                      {v.guestName && <span class="text-sm font-medium text-white">{v.guestName}</span>}
                      {v.date && <span class="text-xs text-white/40">{v.date}</span>}
                    </div>
                  </div>
                </div>

                <div class="vt-controls absolute inset-x-0 bottom-0 z-20 flex justify-center pb-6 opacity-0 transition-opacity duration-300 pointer-events-none">
                  <button class="vt-play-btn pointer-events-auto flex items-center gap-2.5 rounded-full bg-white/95 px-5 py-3 shadow-lg backdrop-blur-sm transition-transform duration-200 hover:scale-105 active:scale-95">
                    <svg class="vt-icon-play h-5 w-5 text-brand-blue" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="vt-icon-pause h-5 w-5 text-brand-blue hidden" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                    <span class="vt-btn-text text-sm font-semibold text-dark/90">Play Story</span>
                  </button>
                </div>
              </div>
            </div>
          );
        })}
        <div class="flex-shrink-0 w-px" aria-hidden="true" />
      </div>

      <button
        class="vt-prev-mobile sm:hidden absolute left-2 top-1/2 -translate-y-1/2 z-30 flex h-10 w-10 items-center justify-center rounded-full bg-white/90 text-dark shadow-lg"
        aria-label="Previous"
      >
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      </button>
      <button
        class="vt-next-mobile sm:hidden absolute right-2 top-1/2 -translate-y-1/2 z-30 flex h-10 w-10 items-center justify-center rounded-full bg-white/90 text-dark shadow-lg"
        aria-label="Next"
      >
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
      </button>
    </div>
  </section>
)}

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

  .vt-slider {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }
  @media (min-width: 640px) {
    .vt-slider { padding-left: 3rem; padding-right: 3rem; }
  }
  @media (min-width: 1024px) {
    .vt-slider { padding-left: 5rem; padding-right: 5rem; }
  }

  .vt-card:hover .vt-controls,
  .vt-card[data-playing] .vt-controls { opacity: 1; }

  .vt-card:hover .vt-quote,
  .vt-card:hover .vt-meta { opacity: 0; transform: translateY(8px); }

  .vt-card[data-playing] .vt-quote,
  .vt-card[data-playing] .vt-meta { opacity: 0; transform: translateY(8px); }

  .vt-card:hover .vt-overlay { background: rgba(0, 0, 0, 0.15); }

  .vt-card[data-playing] .vt-video { opacity: 1; }
</style>

<script is:inline>
(function () {
  var tracks = document.querySelectorAll(".vt-track");
  tracks.forEach(function (track) {
    var slider = track.querySelector(".vt-slider");
    if (!slider) return;

    var cards = track.querySelectorAll(".vt-card");
    var cardWidth = 0;

    function getCardWidth() {
      var first = cards[0];
      if (first) cardWidth = first.offsetWidth + 16;
    }
    getCardWidth();
    window.addEventListener("resize", getCardWidth);

    function scrollBy(dir) {
      slider.scrollBy({ left: dir * cardWidth, behavior: "smooth" });
    }

    var section = track.closest("section");
    if (section) {
      section.querySelectorAll(".vt-prev").forEach(function (btn) {
        btn.addEventListener("click", function () { scrollBy(-1); });
      });
      section.querySelectorAll(".vt-next").forEach(function (btn) {
        btn.addEventListener("click", function () { scrollBy(1); });
      });
    }
    track.querySelectorAll(".vt-prev-mobile").forEach(function (btn) {
      btn.addEventListener("click", function () { scrollBy(-1); });
    });
    track.querySelectorAll(".vt-next-mobile").forEach(function (btn) {
      btn.addEventListener("click", function () { scrollBy(1); });
    });

    var currentlyPlaying = null;

    function stopCard(card) {
      var video = card.querySelector(".vt-video");
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
      card.removeAttribute("data-playing");
      var iconPlay = card.querySelector(".vt-icon-play");
      var iconPause = card.querySelector(".vt-icon-pause");
      var btnText = card.querySelector(".vt-btn-text");
      if (iconPlay) iconPlay.classList.remove("hidden");
      if (iconPause) iconPause.classList.add("hidden");
      if (btnText) btnText.textContent = "Play Story";
    }

    function playCard(card) {
      if (currentlyPlaying && currentlyPlaying !== card) {
        stopCard(currentlyPlaying);
      }

      var video = card.querySelector(".vt-video");
      if (video) video.play();

      card.setAttribute("data-playing", "");
      var iconPlay = card.querySelector(".vt-icon-play");
      var iconPause = card.querySelector(".vt-icon-pause");
      var btnText = card.querySelector(".vt-btn-text");
      if (iconPlay) iconPlay.classList.add("hidden");
      if (iconPause) iconPause.classList.remove("hidden");
      if (btnText) btnText.textContent = "Pause Story";
      currentlyPlaying = card;
    }

    cards.forEach(function (card) {
      var playBtn = card.querySelector(".vt-play-btn");
      if (!playBtn) return;

      playBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        if (card.hasAttribute("data-playing")) {
          stopCard(card);
          currentlyPlaying = null;
        } else {
          playCard(card);
        }
      });
    });
  });
})();
</script>
