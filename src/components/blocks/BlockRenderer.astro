---
import ContentBlock from "@/components/sections/ContentBlock.astro";
import ImageBreak from "@/components/sections/ImageBreak.astro";
import ImageGrid from "@/components/sections/ImageGrid.astro";
import ImageCarousel from "@/components/sections/ImageCarousel.astro";
import VideoBlock from "@/components/sections/VideoBlock.astro";
import CTASection from "@/components/sections/CTASection.astro";
import HighlightsGridBlock from "./HighlightsGridBlock.astro";
import InclusionsGridBlock from "./InclusionsGridBlock.astro";
import FaqSectionBlock from "./FaqSectionBlock.astro";
import VideoTestimonialsBlock from "./VideoTestimonialsBlock.astro";
import SurfIntroBlock from "./SurfIntroBlock.astro";
import SurfForecastBlock from "./SurfForecastBlock.astro";
import SurfSpotsBlock from "./SurfSpotsBlock.astro";
import SurfLevelsBlock from "./SurfLevelsBlock.astro";
import SurfScheduleBlock from "./SurfScheduleBlock.astro";
import SurfEquipmentBlock from "./SurfEquipmentBlock.astro";
import FoodIntroBlock from "./FoodIntroBlock.astro";
import MealCardsBlock from "./MealCardsBlock.astro";
import MenuTableBlock from "./MenuTableBlock.astro";
import DietaryOptionsBlock from "./DietaryOptionsBlock.astro";
import RoomTypesBlock from "./RoomTypesBlock.astro";
import RoomInclusionsBlock from "./RoomInclusionsBlock.astro";
import RoomFacilitiesBlock from "./RoomFacilitiesBlock.astro";
import ImageGalleryBlock from "./ImageGalleryBlock.astro";

interface Props {
  blocks: any[];
  campData?: any;
}

const { blocks = [], campData } = Astro.props;

const ASPECT_MAP = { "16/9": "16:9", "4/3": "4:3", "3/2": "3:2", "1/1": "1:1" } as Record<string, string>;
const VIDEO_TYPE_MAP = { youtube: "youtube", vimeo: "vimeo", wistia: "wistia", file: "file" } as Record<string, string>;

function portableTextToHtml(body: any): string {
  if (Array.isArray(body)) {
    return body
      .map((b: any) => b.children?.map((c: any) => c.text).join("") || "")
      .map((t: string) => "<p>" + t + "</p>")
      .join("");
  }
  if (typeof body === "string") {
    return body.split("\n\n").map((p: string) => "<p>" + p + "</p>").join("");
  }
  return "";
}
---

{blocks.map((block) => {
  const type = block._type;

  if (type === "surfIntro") return <SurfIntroBlock block={block} campData={campData} />;
  if (type === "surfForecast") return <SurfForecastBlock block={block} campData={campData} />;
  if (type === "surfSpots") return <SurfSpotsBlock block={block} />;
  if (type === "surfLevels") return <SurfLevelsBlock block={block} />;
  if (type === "surfSchedule") return <SurfScheduleBlock block={block} />;
  if (type === "surfEquipment") return <SurfEquipmentBlock block={block} />;

  if (type === "foodIntro") return <FoodIntroBlock block={block} />;
  if (type === "mealCards") return <MealCardsBlock block={block} />;
  if (type === "menuTable") return <MenuTableBlock block={block} />;
  if (type === "dietaryOptions") return <DietaryOptionsBlock block={block} />;

  if (type === "roomTypes") return <RoomTypesBlock block={block} />;
  if (type === "roomInclusions") return <RoomInclusionsBlock block={block} />;
  if (type === "roomFacilities") return <RoomFacilitiesBlock block={block} />;

  if (type === "imageGallery") return <ImageGalleryBlock block={block} />;

  if (type === "imageGrid") {
    const images = (block.images || []).map((img: any) => ({
      src: img.resolvedUrl || "",
      alt: img.alt || "",
    }));
    if (images.length >= 3) return <ImageGrid images={images} variant="collage" />;
    if (images.length >= 2) return <ImageGrid images={images} variant="two-up" />;
    return null;
  }

  if (type === "imageCarousel") {
    const images = (block.images || []).map((img: any) => ({
      src: img.resolvedUrl || "",
      alt: img.alt || "",
      caption: img.caption,
    }));
    return <ImageCarousel images={images} aspect={ASPECT_MAP[block.aspect] || "16:9"} />;
  }

  if (type === "videoBlock") {
    return <VideoBlock
      type={VIDEO_TYPE_MAP[block.type] || "youtube"}
      src={block.videoId || ""}
      title={block.title}
      poster={block.resolvedPosterUrl}
      autoplay={block.autoplay || false}
      aspect={block.aspect === "4/3" ? "4:3" : block.aspect === "21/9" ? "21:9" : "16:9"}
      controls
    />;
  }

  if (type === "videoTestimonials") return <VideoTestimonialsBlock block={block} />;
  if (type === "highlightsGrid") return <HighlightsGridBlock block={block} />;
  if (type === "inclusionsGrid") return <InclusionsGridBlock block={block} />;
  if (type === "faqSection") return <FaqSectionBlock block={block} />;

  if (type === "imageBreak") {
    return <ImageBreak
      src={block.resolvedImageUrl || block.imageUrl || block.image?.asset?.url || ""}
      alt={block.alt || ""}
      caption={block.caption || ""}
      height={block.height === "sm" ? "short" : block.height === "lg" ? "tall" : "medium"}
    />;
  }

  if (type === "contentBlock") {
    const body = portableTextToHtml(block.body);
    return <ContentBlock
      heading={block.heading || ""}
      body={body}
      image={block.image?.asset?.url || ""}
      imageAlt={block.imageAlt || ""}
      reverse={block.reverse || false}
      background={block.background === "dark-lighter" ? "dark-lighter" : "dark"}
    />;
  }

  if (type === "ctaSection") return <CTASection
    heading={block.heading}
    text={block.text}
    buttonText={block.buttonText}
    buttonUrl={block.buttonUrl || campData?.bookingUrl}
    faqSlug={campData?.slug}
    blogCategory={campData?.countrySlug}
  />;

  return null;
})}
