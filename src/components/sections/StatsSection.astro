---
interface StatInput {
  label: string;
  value: string;
}

interface Props {
  stats?: StatInput[];
}

const icons: Record<string, string> = {
  "EST": "M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z",
  "Established": "M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z",
  "GegrÃ¼ndet": "M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z",
  "Happy Customers": "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75",
  "Zufriedene Kunden": "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75",
  "TripAdvisor Awards": "M6 9a6 6 0 0 1 12 0c0 3-2 5.5-6 8.5C8 14.5 6 12 6 9zM12 2v1M4.22 4.22l.7.7M1 9h1M4.22 13.78l.7-.7M19.78 4.22l-.7.7M23 9h-1M19.78 13.78l-.7-.7",
  "TripAdvisor Auszeichnungen": "M6 9a6 6 0 0 1 12 0c0 3-2 5.5-6 8.5C8 14.5 6 12 6 9zM12 2v1M4.22 4.22l.7.7M1 9h1M4.22 13.78l.7-.7M19.78 4.22l-.7.7M23 9h-1M19.78 13.78l-.7-.7",
  "Destinations": "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0zM12 7a3 3 0 1 0 0 6 3 3 0 0 0 0-6z",
  "Reiseziele": "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0zM12 7a3 3 0 1 0 0 6 3 3 0 0 0 0-6z",
  "Instagram Followers": "M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2",
};

const fallbackStats: StatInput[] = [
  { label: "Established", value: "2003" },
  { label: "Happy Customers", value: "80k+" },
  { label: "TripAdvisor Awards", value: "23" },
  { label: "Destinations", value: "8" },
];

const rawStats = Astro.props.stats?.length ? Astro.props.stats : fallbackStats;

function parseValue(val: string): { numericEnd: number; suffix: string } {
  const match = val.match(/^(\d+)(.*)/);
  if (!match) return { numericEnd: 0, suffix: "" };
  return { numericEnd: parseInt(match[1], 10), suffix: match[2] || "" };
}

const stats = rawStats.map((s: StatInput) => {
  const { numericEnd, suffix } = parseValue(s.value);
  return {
    label: s.label,
    value: s.value,
    numericEnd,
    suffix,
    icon: icons[s.label] || icons["Destinations"],
  };
});
---

<section class="py-16 sm:py-20 relative overflow-hidden">
  <!-- Subtle background glow -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[300px] bg-ocean/5 rounded-full blur-[100px]"></div>
  </div>

  <div class="relative px-6 sm:px-12 lg:px-20">
    <!-- Desktop: single row with dividers / Mobile: 2x2 grid -->
    <div class="hidden lg:flex items-center justify-between">
      {stats.map((stat, i) => (
        <>
          <div class="stat-item flex-1 flex flex-col items-center text-center py-4" data-end={stat.numericEnd} data-suffix={stat.suffix || ""} data-raw={stat.value}>
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-ocean/10 mb-4">
              <svg class="h-4.5 w-4.5 text-ocean-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d={stat.icon} />
              </svg>
            </div>
            <p class="stat-value text-4xl xl:text-5xl font-bold tracking-tight leading-none bg-gradient-to-b from-white to-white/60 bg-clip-text text-transparent">
              {stat.value}
            </p>
            <p class="mt-2 text-sm text-white/35 font-medium">{stat.label}</p>
          </div>
          {i < stats.length - 1 && (
            <div class="w-px h-20 bg-gradient-to-b from-transparent via-white/10 to-transparent flex-shrink-0 mx-4"></div>
          )}
        </>
      ))}
    </div>

    <!-- Mobile: 2x2 grid -->
    <div class="grid grid-cols-2 gap-3 lg:hidden">
      {stats.map((stat) => (
        <div class="stat-item rounded-2xl bg-white/[0.03] border border-white/[0.06] px-5 py-7 flex flex-col items-center text-center" data-end={stat.numericEnd} data-suffix={stat.suffix || ""} data-raw={stat.value}>
          <div class="flex h-9 w-9 items-center justify-center rounded-full bg-ocean/10 mb-3">
            <svg class="h-4 w-4 text-ocean-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d={stat.icon} />
            </svg>
          </div>
          <p class="stat-value text-3xl sm:text-4xl font-bold tracking-tight leading-none bg-gradient-to-b from-white to-white/60 bg-clip-text text-transparent">
            {stat.value}
          </p>
          <p class="mt-2 text-xs text-white/35 font-medium">{stat.label}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<script is:inline>
(function () {
  var animated = false;
  var items = document.querySelectorAll(".stat-item");
  if (!items.length) return;

  function animateCountUp() {
    if (animated) return;
    animated = true;

    items.forEach(function (item) {
      var el = item.querySelector(".stat-value");
      if (!el) return;

      var end = parseInt(item.getAttribute("data-end"), 10);
      var suffix = item.getAttribute("data-suffix") || "";
      var raw = item.getAttribute("data-raw") || "";

      if (isNaN(end)) { el.textContent = raw; return; }

      var duration = 2000;
      var start = 0;
      var startTime = null;

      function step(ts) {
        if (!startTime) startTime = ts;
        var progress = Math.min((ts - startTime) / duration, 1);
        var ease = 1 - Math.pow(1 - progress, 3);
        var current = Math.round(start + (end - start) * ease);
        el.textContent = (end > 999 && !suffix ? current.toString() : current.toLocaleString()) + suffix;
        if (progress < 1) requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    });
  }

  if ("IntersectionObserver" in window) {
    var observer = new IntersectionObserver(function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          animateCountUp();
          observer.disconnect();
        }
      });
    }, { threshold: 0.3 });
    observer.observe(items[0].closest("section"));
  } else {
    animateCountUp();
  }
})();
</script>
