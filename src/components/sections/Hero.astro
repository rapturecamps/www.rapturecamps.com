---
interface Props {
  title: string;
  subtitle?: string;
  tagline?: string;
  backgroundImage?: string;
  backgroundImages?: string[];
  backgroundVideo?: string;
  videoPoster?: string;
  showScrollIndicator?: boolean;
  ctaText?: string;
  ctaHref?: string;
  /** Seconds between image transitions (default 6) */
  rotationInterval?: number;
  /** Use "large" for homepage slogan, "default" for camp/country pages */
  titleSize?: "default" | "large";
  /** Full viewport height on all screens (homepage) vs compact on mobile (camp pages) */
  fullHeight?: boolean;
}

const {
  title,
  subtitle,
  tagline,
  backgroundImage = "https://images.unsplash.com/photo-1530053969600-caed2596d242?w=1920&h=1080&fit=crop",
  backgroundImages,
  backgroundVideo,
  videoPoster,
  showScrollIndicator = false,
  ctaText,
  ctaHref,
  rotationInterval = 6,
  titleSize = "default",
  fullHeight = false,
} = Astro.props;

const titleClasses = titleSize === "large"
  ? "text-6xl sm:text-7xl md:text-8xl lg:text-9xl"
  : "text-4xl sm:text-6xl md:text-7xl lg:text-8xl";

const hasVideo = !!backgroundVideo;
const videoSources = hasVideo
  ? [
      { src: `${backgroundVideo}?v=hevc`, type: "video/mp4; codecs=hvc1" },
      { src: `${backgroundVideo}?v=vp9`, type: "video/webm; codecs=vp9" },
      { src: backgroundVideo, type: "video/mp4" },
    ]
  : [];
const images = backgroundImages && backgroundImages.length > 1
  ? backgroundImages
  : [backgroundImage];
const hasRotation = !hasVideo && images.length > 1;

---

<section class:list={["relative flex items-end overflow-hidden", fullHeight ? "h-[calc(100vh-85px)] sm:h-[calc(100vh-170px)] min-h-[600px] sm:min-h-[530px]" : "h-[calc(65vh-170px)] sm:h-[calc(100vh-170px)] min-h-[310px] sm:min-h-[530px]"]}>

  {hasVideo ? (
    <video
      autoplay
      loop
      muted
      playsinline
      class="absolute inset-0 h-full w-full object-cover"
      poster={videoPoster || backgroundImage}
    >
      {videoSources.map(({ src, type }) => (
        <source src={src} type={type} />
      ))}
    </video>
  ) : hasRotation ? (
    <div class="hero-slideshow absolute inset-0" data-interval={rotationInterval}>
      {images.map((src, i) => (
        <div
          class:list={[
            "hero-slide absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-[1500ms] ease-in-out",
            i === 0 ? "opacity-100" : "opacity-0",
          ]}
          style={i === 0 ? `background-image: url(${src})` : undefined}
          data-bg={i > 0 ? src : undefined}
          data-slide={i}
        />
      ))}
    </div>
  ) : (
    <div
      class="absolute inset-0 bg-cover bg-center bg-no-repeat"
      style={`background-image: url(${backgroundImage})`}
    />
  )}

  <div class="absolute inset-0 bg-gradient-to-b from-dark/40 via-dark/20 to-dark" />

  <div class:list={["relative z-10 px-6 sm:px-12 lg:px-20 max-w-5xl", fullHeight ? "pb-[87px] sm:pb-16 lg:pb-20" : "pb-12 sm:pb-16 lg:pb-20"]}>
    {tagline && (
      <p class="mb-4 text-xs sm:text-sm uppercase tracking-[0.25em] text-white/50 font-light">
        {tagline}
      </p>
    )}

    <p class:list={["font-display font-bold text-white leading-[0.95] tracking-tight whitespace-pre-line", titleClasses]} role="heading" aria-level="2">
      {title}
    </p>

    {subtitle && (
      <p class="mt-3 sm:mt-6 text-base sm:text-lg text-white/60 max-w-lg leading-relaxed font-light">
        {subtitle}
      </p>
    )}

    <slot />

    {ctaText && ctaHref && (
      <div class="hidden sm:block mt-5 sm:mt-8">
        <a
          href={ctaHref}
          class="inline-block rounded-full bg-white/10 border border-white/20 px-7 py-3 text-sm font-medium text-white hover:bg-white/20 transition-all"
        >
          {ctaText}
        </a>
      </div>
    )}
  </div>

  {showScrollIndicator && (
    <div class="absolute bottom-8 left-6 sm:left-12 lg:left-20 z-10">
      <a
        href="#destinations"
        class="flex items-center gap-2 text-xs uppercase tracking-[0.2em] text-white/40 hover:text-white/70 transition-colors"
      >
        <span>Or Scroll Down</span>
        <svg class="h-4 w-4 animate-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m6 9 6 6 6-6" />
        </svg>
      </a>
    </div>
  )}
</section>

<script is:inline>
  (function () {
    var slideshows = document.querySelectorAll(".hero-slideshow");
    slideshows.forEach(function (ss) {
      var slides = ss.querySelectorAll(".hero-slide");
      if (slides.length < 2) return;

      var interval = parseInt(ss.getAttribute("data-interval") || "6", 10) * 1000;
      var current = 0;
      var total = slides.length;
      var paused = false;
      var loaded = false;

      function loadDeferred() {
        if (loaded) return;
        loaded = true;
        for (var i = 0; i < slides.length; i++) {
          var bg = slides[i].getAttribute("data-bg");
          if (bg) {
            slides[i].style.backgroundImage = "url(" + bg + ")";
            slides[i].removeAttribute("data-bg");
          }
        }
      }

      function next() {
        if (paused) return;
        if (!loaded) loadDeferred();
        slides[current].classList.remove("opacity-100");
        slides[current].classList.add("opacity-0");
        current = (current + 1) % total;
        slides[current].classList.remove("opacity-0");
        slides[current].classList.add("opacity-100");
      }

      setTimeout(loadDeferred, 2000);
      setInterval(next, interval);

      document.addEventListener("visibilitychange", function () {
        paused = document.hidden;
      });
    });
  })();
</script>
