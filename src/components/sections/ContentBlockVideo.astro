---
import { bunnyEmbedUrl } from "@/lib/sanity";

interface Props {
  heading: string;
  body: string;
  videoType: "youtube" | "vimeo" | "wistia" | "bunny" | "file";
  videoSrc: string;
  videoPoster?: string;
  reverse?: boolean;
  background?: "dark" | "dark-lighter";
  headingTag?: "h1" | "h2" | "h3" | "h4";
}

const {
  heading,
  body,
  videoType,
  videoSrc,
  videoPoster,
  reverse = false,
  background = "dark",
  headingTag = "h2",
} = Astro.props;

const HeadingTag = headingTag;
const bgClass = background === "dark-lighter" ? "bg-dark-lighter" : "bg-dark";

function youtubeEmbedUrl(id: string) {
  const params = new URLSearchParams({ rel: "0", modestbranding: "1", showinfo: "0" });
  return `https://www.youtube.com/embed/${id}?${params}`;
}

function vimeoEmbedUrl(id: string) {
  return `https://player.vimeo.com/video/${id}`;
}

function wistiaEmbedUrl(id: string) {
  const params = new URLSearchParams({ controlsVisibleOnLoad: "true", playbar: "true" });
  return `https://fast.wistia.net/embed/iframe/${id}?${params}`;
}
---

<section class:list={["py-16 sm:py-20", bgClass]}>
  <div class="px-6 sm:px-12 lg:px-20">
    {videoSrc ? (
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-x-16 lg:gap-y-4">
        <HeadingTag
          class:list={[
            "text-2xl sm:text-3xl lg:text-4xl font-semibold text-white",
            "lg:row-start-1 lg:self-end lg:pb-0",
            reverse ? "lg:col-start-2" : "lg:col-start-1",
          ]}
        >{heading}</HeadingTag>

        <div class:list={[
          "relative aspect-video overflow-hidden rounded-xl",
          "lg:row-start-1 lg:row-span-2 lg:self-center",
          reverse ? "lg:col-start-1" : "lg:col-start-2",
        ]}>
          {videoType === "file" && (
            <video
              src={videoSrc}
              class="absolute inset-0 h-full w-full object-cover"
              controls
              playsinline
              poster={videoPoster}
              preload={videoPoster ? "none" : "metadata"}
            />
          )}

          {videoType === "youtube" && (
            <div class="yt-facade absolute inset-0 cursor-pointer" data-yt-id={videoSrc} data-yt-url={youtubeEmbedUrl(videoSrc)}>
              <img
                src={videoPoster || `https://i.ytimg.com/vi/${videoSrc}/hqdefault.jpg`}
                alt={heading || "Video thumbnail"}
                class="h-full w-full object-cover"
                loading="lazy"
              />
              <div class="absolute inset-0 flex items-center justify-center bg-black/30 hover:bg-black/20 transition-colors">
                <svg class="h-14 w-14 sm:h-16 sm:w-16 text-white drop-shadow-lg" viewBox="0 0 68 48">
                  <path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55C3.97 2.33 2.27 4.81 1.48 7.74.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red" />
                  <path d="M45 24L27 14v20" fill="white" />
                </svg>
              </div>
            </div>
          )}

          {videoType === "vimeo" && (
            <iframe
              src={vimeoEmbedUrl(videoSrc)}
              class="absolute inset-0 h-full w-full"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              loading="lazy"
            />
          )}

          {videoType === "wistia" && (
            <iframe
              src={wistiaEmbedUrl(videoSrc)}
              class="absolute inset-0 h-full w-full"
              allow="autoplay; fullscreen"
              allowfullscreen
              loading="lazy"
            />
          )}

          {videoType === "bunny" && (
            <iframe
              src={bunnyEmbedUrl(videoSrc)}
              class="absolute inset-0 h-full w-full"
              allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
              allowfullscreen
              loading="lazy"
              style="border: none;"
            />
          )}
        </div>

        <div class:list={[
          "text-base text-white/50 leading-relaxed space-y-4",
          "lg:row-start-2 lg:self-start",
          reverse ? "lg:col-start-2" : "lg:col-start-1",
        ]} set:html={body} />
      </div>
    ) : (
      <div>
        <HeadingTag class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-white mb-6">{heading}</HeadingTag>
        <div class="text-base text-white/50 leading-relaxed space-y-4" set:html={body} />
      </div>
    )}
  </div>
</section>

<script is:inline>
(function () {
  document.querySelectorAll(".yt-facade").forEach(function (el) {
    el.addEventListener("click", function () {
      var url = el.getAttribute("data-yt-url");
      if (!url) return;
      var sep = url.indexOf("?") > -1 ? "&" : "?";
      var iframe = document.createElement("iframe");
      iframe.src = url + sep + "autoplay=1";
      iframe.className = "absolute inset-0 h-full w-full";
      iframe.allow = "autoplay; encrypted-media; picture-in-picture";
      iframe.allowFullscreen = true;
      el.replaceWith(iframe);
    });
  });
})();
</script>
