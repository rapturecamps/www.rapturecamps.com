---
import { bunnyEmbedUrl } from "@/lib/sanity";

export interface Props {
  /** "file" for direct MP4/WebM URLs, "bunny" for Bunny CDN Stream, or "youtube" | "vimeo" | "wistia" */
  type: "file" | "bunny" | "youtube" | "vimeo" | "wistia";
  /** File URL, YouTube video ID, Vimeo video ID, or Wistia video ID */
  src: string;
  /** Optional heading above the video */
  title?: string;
  /** Optional description below the heading */
  description?: string;
  /** Aspect ratio class â€” defaults to 16:9 */
  aspect?: "16:9" | "4:3" | "1:1" | "21:9";
  /** Autoplay (muted). Defaults to false */
  autoplay?: boolean;
  /** Show player controls. Defaults to true */
  controls?: boolean;
  /** Loop the video. Defaults to false */
  loop?: boolean;
  /** Poster/thumbnail image URL (file type only) */
  poster?: string;
  /** Background variant */
  background?: "dark" | "dark-lighter";
  /** Full-bleed (no horizontal padding). Defaults to false */
  fullBleed?: boolean;
  /** Optional caption below the video */
  caption?: string;
}

const {
  type,
  src,
  title,
  description,
  aspect = "16:9",
  autoplay = false,
  controls = true,
  loop = false,
  poster,
  background = "dark",
  fullBleed = false,
  caption,
} = Astro.props;

const aspectClass: Record<string, string> = {
  "16:9": "aspect-video",
  "4:3": "aspect-[4/3]",
  "1:1": "aspect-square",
  "21:9": "aspect-[21/9]",
};

const bgClass = background === "dark-lighter" ? "bg-dark-lighter" : "bg-dark";
const ratio = aspectClass[aspect] || "aspect-video";

const isBunny = type === "bunny";

function youtubeEmbedUrl(id: string) {
  const params = new URLSearchParams({
    rel: "0",
    modestbranding: "1",
    showinfo: "0",
  });
  if (autoplay) { params.set("autoplay", "1"); params.set("mute", "1"); }
  if (loop) { params.set("loop", "1"); params.set("playlist", id); }
  if (!controls) params.set("controls", "0");
  return `https://www.youtube.com/embed/${id}?${params}`;
}

function vimeoEmbedUrl(id: string) {
  const params = new URLSearchParams();
  if (autoplay) { params.set("autoplay", "1"); params.set("muted", "1"); }
  if (loop) params.set("loop", "1");
  if (!controls) params.set("background", "1");
  return `https://player.vimeo.com/video/${id}?${params}`;
}

function wistiaEmbedUrl(id: string) {
  const params = new URLSearchParams({
    controlsVisibleOnLoad: controls ? "true" : "false",
    playbar: controls ? "true" : "false",
  });
  if (autoplay) { params.set("autoPlay", "true"); params.set("silentAutoPlay", "true"); }
  if (loop) params.set("endVideoBehavior", "loop");
  if (!controls) {
    params.set("smallPlayButton", "false");
    params.set("volumeControl", "false");
    params.set("fullscreenButton", "false");
  }
  return `https://fast.wistia.net/embed/iframe/${id}?${params}`;
}
---

<section class:list={["py-12 sm:py-16", bgClass]}>
  <div class:list={[fullBleed ? "" : "px-6 sm:px-12 lg:px-20"]}>
    {(title || description) && (
      <div class:list={["mb-6", fullBleed && "px-6 sm:px-12 lg:px-20"]}>
        {title && <h2 class="text-xl sm:text-2xl lg:text-3xl font-semibold text-white mb-2">{title}</h2>}
        {description && <p class="text-sm sm:text-base text-white/40 max-w-2xl">{description}</p>}
      </div>
    )}

    <div class:list={["relative overflow-hidden rounded-xl", ratio, fullBleed && "rounded-none"]}>
      {type === "file" && (
        <video
          src={src}
          class="absolute inset-0 h-full w-full object-cover"
          autoplay={autoplay}
          muted={autoplay}
          loop={loop}
          controls={controls}
          playsinline
          poster={poster}
          preload={poster ? "none" : "metadata"}
        />
      )}

      {isBunny && (
        <iframe
          src={bunnyEmbedUrl(src, { autoplay, loop, muted: autoplay })}
          class="absolute inset-0 h-full w-full"
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture"
          allowfullscreen
          loading="lazy"
          style="border: none;"
        />
      )}

      {type === "youtube" && !autoplay && (
        <div class="yt-facade absolute inset-0 cursor-pointer" data-yt-id={src} data-yt-url={youtubeEmbedUrl(src)}>
          <img
            src={`https://i.ytimg.com/vi/${src}/hqdefault.jpg`}
            alt={title || "Video thumbnail"}
            class="h-full w-full object-cover"
            loading="lazy"
          />
          <div class="absolute inset-0 flex items-center justify-center bg-black/30 hover:bg-black/20 transition-colors">
            <svg class="h-16 w-16 sm:h-20 sm:w-20 text-white drop-shadow-lg" viewBox="0 0 68 48">
              <path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55C3.97 2.33 2.27 4.81 1.48 7.74.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/>
              <path d="M45 24L27 14v20" fill="white"/>
            </svg>
          </div>
        </div>
      )}

      {type === "youtube" && autoplay && (
        <iframe
          src={youtubeEmbedUrl(src)}
          class="absolute inset-0 h-full w-full"
          allow="autoplay; encrypted-media; picture-in-picture"
          allowfullscreen
          loading="lazy"
        />
      )}

      {type === "vimeo" && (
        <iframe
          src={vimeoEmbedUrl(src)}
          class="absolute inset-0 h-full w-full"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          loading="lazy"
        />
      )}

      {type === "wistia" && (
        <iframe
          src={wistiaEmbedUrl(src)}
          class="absolute inset-0 h-full w-full"
          allow="autoplay; fullscreen"
          allowfullscreen
          loading="lazy"
        />
      )}
    </div>

    {caption && (
      <p class:list={["text-xs text-white/25 mt-3", fullBleed && "px-6 sm:px-12 lg:px-20"]}>{caption}</p>
    )}
  </div>
</section>

<script is:inline>
(function () {
  document.querySelectorAll(".yt-facade").forEach(function (el) {
    el.addEventListener("click", function () {
      var url = el.getAttribute("data-yt-url");
      if (!url) return;
      var sep = url.indexOf("?") > -1 ? "&" : "?";
      var iframe = document.createElement("iframe");
      iframe.src = url + sep + "autoplay=1";
      iframe.className = "absolute inset-0 h-full w-full";
      iframe.allow = "autoplay; encrypted-media; picture-in-picture";
      iframe.allowFullscreen = true;
      el.replaceWith(iframe);
    });
  });
})();
</script>
