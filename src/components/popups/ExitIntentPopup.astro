---
interface Props {
  voucherCode?: string;
  headline?: string;
  body?: string;
  ctaText?: string;
  ctaHref?: string;
}

const {
  voucherCode = "RAPTURE10",
  headline = "Wait â€” don't leave without this!",
  body = "Here's 10% off your next surf camp adventure. Use the code below at checkout.",
  ctaText = "Browse Surf Camps",
  ctaHref = "/surfcamp",
} = Astro.props;
---

<!-- Exit Intent Popup -->
<div
  id="popup-exit-intent"
  class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/60 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-label="Special offer"
>
  <div
    class="popup-card relative mx-4 w-full max-w-md scale-95 opacity-0 transition-all duration-300 ease-out rounded-2xl overflow-hidden shadow-2xl"
  >
    <!-- Top accent bar -->
    <div class="h-1.5 bg-gradient-to-r from-brand-blue via-ocean to-ocean-light" />

    <div class="bg-white p-8 sm:p-10 text-center">
      <!-- Close button -->
      <button
        class="popup-close absolute top-4 right-4 flex h-8 w-8 items-center justify-center rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors"
        aria-label="Close"
      >
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>

      <!-- Icon -->
      <div class="mx-auto mb-5 flex h-16 w-16 items-center justify-center rounded-full bg-brand-blue/10">
        <svg class="h-8 w-8 text-brand-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.8 10H2.2c-.6 0-1 .5-.9 1.1l1.5 8.1A2 2 0 0 0 4.7 21h14.6a2 2 0 0 0 1.9-1.8l1.5-8.1c.1-.6-.3-1.1-.9-1.1Z"/>
          <path d="m2.2 10 3.3-5.5A2 2 0 0 1 7.2 3h9.6a2 2 0 0 1 1.7 1.5L21.8 10"/>
          <path d="M12 3v7"/>
        </svg>
      </div>

      <h3 class="text-2xl font-bold text-gray-900 mb-2">{headline}</h3>
      <p class="text-gray-500 text-sm leading-relaxed mb-6">{body}</p>

      <!-- Voucher code -->
      <div class="relative mx-auto mb-6 max-w-xs">
        <div
          class="voucher-display flex items-center justify-between rounded-xl border-2 border-dashed border-brand-blue/30 bg-brand-blue/5 px-5 py-3.5"
        >
          <span class="voucher-code text-lg font-bold tracking-widest text-brand-blue">{voucherCode}</span>
          <button
            class="voucher-copy ml-3 flex items-center gap-1.5 rounded-lg bg-brand-blue px-3 py-1.5 text-xs font-semibold text-white hover:bg-ocean transition-colors"
          >
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            <span class="voucher-copy-label">Copy</span>
          </button>
        </div>
      </div>

      <a
        href={ctaHref}
        class="popup-close inline-block rounded-full bg-brand-blue px-8 py-3 text-sm font-semibold text-white hover:bg-ocean transition-colors"
      >
        {ctaText}
      </a>
    </div>
  </div>
</div>

<script is:inline>
(function () {
  var popup = document.getElementById("popup-exit-intent");
  if (!popup) return;

  var card = popup.querySelector(".popup-card");
  var copyBtn = popup.querySelector(".voucher-copy");
  var codeEl = popup.querySelector(".voucher-code");
  var copyLabel = popup.querySelector(".voucher-copy-label");

  function show() {
    popup.classList.remove("hidden");
    popup.classList.add("flex");
    document.body.style.overflow = "hidden";
    requestAnimationFrame(function () {
      requestAnimationFrame(function () {
        card.classList.remove("scale-95", "opacity-0");
        card.classList.add("scale-100", "opacity-100");
      });
    });
  }

  function hide() {
    card.classList.remove("scale-100", "opacity-100");
    card.classList.add("scale-95", "opacity-0");
    setTimeout(function () {
      popup.classList.add("hidden");
      popup.classList.remove("flex");
      document.body.style.overflow = "";
    }, 300);
  }

  popup.querySelectorAll(".popup-close").forEach(function (el) {
    el.addEventListener("click", function (e) {
      if (el.tagName === "BUTTON") e.preventDefault();
      hide();
    });
  });

  popup.addEventListener("click", function (e) {
    if (e.target === popup) hide();
  });

  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && !popup.classList.contains("hidden")) hide();
  });

  if (copyBtn && codeEl) {
    copyBtn.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      var code = codeEl.textContent.trim();
      navigator.clipboard.writeText(code).then(function () {
        copyLabel.textContent = "Copied!";
        setTimeout(function () { copyLabel.textContent = "Copy"; }, 2000);
      });
    });
  }

  window.addEventListener("rc:show-popup", function (e) {
    if (e.detail && e.detail.type === "exit-intent") show();
  });
})();
</script>
