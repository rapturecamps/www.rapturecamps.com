---
/**
 * Spinning Wheel Popup — "Spin to Win"
 * Wheel is visible from the start alongside the email form.
 * After entering email, the wheel spins and reveals the prize.
 * Segments array can be made CMS-editable via Sanity.
 */

interface Segment {
  label: string;
  color: string;
  prize: string;
  probability: number;
}

interface Props {
  headline?: string;
  subheadline?: string;
  segments?: Segment[];
}

const defaultSegments: Segment[] = [
  { label: "5% Off",          color: "#005AFF", prize: "SPIN5",      probability: 25 },
  { label: "10% Off",         color: "#2980b9", prize: "SPIN10",     probability: 20 },
  { label: "Free Yoga",       color: "#005AFF", prize: "FREEYOGA",   probability: 10 },
  { label: "15% Off",         color: "#0f1d32", prize: "SPIN15",     probability: 8 },
  { label: "Surf Lesson",     color: "#2980b9", prize: "FREELESSON", probability: 5 },
  { label: "5% Off",          color: "#005AFF", prize: "SPIN5",      probability: 25 },
  { label: "20% Off",         color: "#0f1d32", prize: "SPIN20",     probability: 2 },
  { label: "Free Tee",        color: "#2980b9", prize: "FREETEE",    probability: 5 },
  { label: "10% Off",         color: "#005AFF", prize: "SPIN10",     probability: 15 },
  { label: "Try Again",       color: "#0f1d32", prize: "",           probability: 10 },
];

const {
  headline = "Spin to Win!",
  subheadline = "Enter your email for a chance to win an exclusive discount on your next surf camp.",
  segments = defaultSegments,
} = Astro.props;

const segmentCount = segments.length;
const segmentAngle = 360 / segmentCount;
---

<!-- Spinning Wheel Popup -->
<div
  id="popup-spinning-wheel"
  class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/60 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-label="Spin to win"
  data-segments={JSON.stringify(segments)}
  data-segment-angle={segmentAngle}
>
  <div class="popup-card relative mx-4 w-full max-w-[540px] scale-95 opacity-0 transition-all duration-300 ease-out rounded-2xl overflow-hidden shadow-2xl">
    <!-- Close button -->
    <button
      class="popup-close absolute top-4 right-4 z-20 flex h-8 w-8 items-center justify-center rounded-full bg-white/10 text-white/60 hover:text-white hover:bg-white/20 transition-colors"
      aria-label="Close"
    >
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>

    <!-- Dark background with wheel always visible -->
    <div class="bg-gradient-to-b from-dark to-dark-lighter px-6 pt-8 pb-6 sm:px-10 sm:pt-10 sm:pb-8">
      <!-- Headline -->
      <div class="text-center mb-6">
        <h3 class="text-2xl sm:text-3xl font-bold text-white mb-1">{headline}</h3>
        <p class="text-white/40 text-sm">{subheadline}</p>
      </div>

      <!-- Wheel container -->
      <div class="relative mx-auto" style="width: 340px; height: 340px; max-width: 100%;">
        <!-- Pointer / ticker -->
        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10">
          <div class="w-0 h-0 border-l-[14px] border-r-[14px] border-t-[24px] border-l-transparent border-r-transparent border-t-white drop-shadow-lg"></div>
        </div>

        <!-- Wheel canvas -->
        <canvas
          id="wheel-canvas"
          width="340"
          height="340"
          class="mx-auto rounded-full shadow-[0_0_40px_rgba(0,90,255,0.25)]"
          style="transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); max-width: 100%; height: auto;"
        ></canvas>
      </div>
    </div>

    <!-- Bottom section: email form / prize reveal -->
    <div class="bg-white px-6 py-6 sm:px-10 sm:py-8">
      <!-- Email form -->
      <div id="wheel-step-email">
        <form id="wheel-email-form" class="flex gap-3">
          <input
            type="email"
            id="wheel-email-input"
            required
            placeholder="your@email.com"
            class="flex-1 min-w-0 rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-900 placeholder-gray-400 outline-none focus:border-brand-blue focus:ring-2 focus:ring-brand-blue/20 transition-all"
          />
          <button
            type="submit"
            id="wheel-spin-btn"
            class="flex-shrink-0 rounded-xl bg-brand-blue px-6 py-3 text-sm font-semibold text-white hover:bg-ocean transition-colors"
          >
            Spin!
          </button>
        </form>
        <p class="mt-3 text-center text-xs text-gray-400">No spam. Unsubscribe anytime.</p>
      </div>

      <!-- Spinning state -->
      <div id="wheel-step-spinning" class="hidden text-center py-2">
        <p class="text-gray-500 text-sm font-medium">Good luck...</p>
      </div>

      <!-- Prize reveal -->
      <div id="wheel-step-prize" class="hidden text-center">
        <div class="flex items-center justify-center gap-2 mb-3">
          <svg class="h-6 w-6 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
          <h4 class="text-xl font-bold text-gray-900" id="wheel-prize-headline">Congratulations!</h4>
        </div>
        <p class="text-gray-500 text-sm mb-4" id="wheel-prize-body">You won a special prize!</p>

        <div id="wheel-prize-code-wrap" class="mx-auto mb-4 max-w-xs">
          <div class="flex items-center justify-between rounded-xl border-2 border-dashed border-green-500/30 bg-green-50 px-5 py-3">
            <span id="wheel-prize-code" class="text-lg font-bold tracking-widest text-green-700"></span>
            <button
              id="wheel-prize-copy"
              class="ml-3 flex items-center gap-1.5 rounded-lg bg-green-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-green-700 transition-colors"
            >
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
              <span id="wheel-prize-copy-label">Copy</span>
            </button>
          </div>
        </div>

        <a
          href="/surfcamp"
          class="popup-close inline-block rounded-full bg-brand-blue px-8 py-3 text-sm font-semibold text-white hover:bg-ocean transition-colors"
        >
          Browse Surf Camps
        </a>
      </div>
    </div>
  </div>
</div>

<script is:inline>
(function () {
  var popup = document.getElementById("popup-spinning-wheel");
  if (!popup) return;

  var card = popup.querySelector(".popup-card");
  var stepEmail = document.getElementById("wheel-step-email");
  var stepSpinning = document.getElementById("wheel-step-spinning");
  var stepPrize = document.getElementById("wheel-step-prize");
  var emailForm = document.getElementById("wheel-email-form");
  var emailInput = document.getElementById("wheel-email-input");
  var spinBtn = document.getElementById("wheel-spin-btn");
  var canvas = document.getElementById("wheel-canvas");
  var prizeHeadline = document.getElementById("wheel-prize-headline");
  var prizeBody = document.getElementById("wheel-prize-body");
  var prizeCode = document.getElementById("wheel-prize-code");
  var prizeCodeWrap = document.getElementById("wheel-prize-code-wrap");
  var prizeCopy = document.getElementById("wheel-prize-copy");
  var prizeCopyLabel = document.getElementById("wheel-prize-copy-label");

  var segments = JSON.parse(popup.getAttribute("data-segments") || "[]");
  var segAngle = parseFloat(popup.getAttribute("data-segment-angle") || "36");
  var ctx = canvas ? canvas.getContext("2d") : null;
  var size = 340;
  var half = size / 2;
  var radius = half - 4;

  function drawWheel() {
    if (!ctx) return;
    ctx.clearRect(0, 0, size, size);
    ctx.save();
    ctx.translate(half, half);

    for (var i = 0; i < segments.length; i++) {
      var startAngle = (i * segAngle - 90) * Math.PI / 180;
      var endAngle = ((i + 1) * segAngle - 90) * Math.PI / 180;

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, radius, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = segments[i].color;
      ctx.fill();

      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // Label
      ctx.save();
      var midAngle = (startAngle + endAngle) / 2;
      ctx.rotate(midAngle);
      ctx.translate(radius * 0.62, 0);
      ctx.rotate(Math.PI / 2);
      ctx.fillStyle = "#ffffff";
      ctx.font = "bold 12px Inter, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(segments[i].label, 0, 0);
      ctx.restore();
    }

    // Center hub
    ctx.beginPath();
    ctx.arc(0, 0, 24, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.beginPath();
    ctx.arc(0, 0, 20, 0, Math.PI * 2);
    ctx.fillStyle = "#005AFF";
    ctx.fill();
    // Inner dot
    ctx.beginPath();
    ctx.arc(0, 0, 6, 0, Math.PI * 2);
    ctx.fillStyle = "#ffffff";
    ctx.fill();

    ctx.restore();
  }

  drawWheel();

  function pickSegment() {
    var totalWeight = 0;
    for (var i = 0; i < segments.length; i++) totalWeight += (segments[i].probability || 1);
    var rand = Math.random() * totalWeight;
    var cumulative = 0;
    for (var i = 0; i < segments.length; i++) {
      cumulative += (segments[i].probability || 1);
      if (rand <= cumulative) return i;
    }
    return 0;
  }

  function show() {
    stepEmail.classList.remove("hidden");
    stepSpinning.classList.add("hidden");
    stepPrize.classList.add("hidden");
    canvas.style.transform = "";
    popup.classList.remove("hidden");
    popup.classList.add("flex");
    document.body.style.overflow = "hidden";
    requestAnimationFrame(function () {
      requestAnimationFrame(function () {
        card.classList.remove("scale-95", "opacity-0");
        card.classList.add("scale-100", "opacity-100");
      });
    });
  }

  function hide() {
    card.classList.remove("scale-100", "opacity-100");
    card.classList.add("scale-95", "opacity-0");
    setTimeout(function () {
      popup.classList.add("hidden");
      popup.classList.remove("flex");
      document.body.style.overflow = "";
    }, 300);
  }

  popup.querySelectorAll(".popup-close").forEach(function (el) {
    el.addEventListener("click", function (e) {
      if (el.tagName === "BUTTON") e.preventDefault();
      hide();
    });
  });

  popup.addEventListener("click", function (e) {
    if (e.target === popup) hide();
  });

  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && !popup.classList.contains("hidden")) hide();
  });

  emailForm.addEventListener("submit", function (e) {
    e.preventDefault();
    var email = emailInput.value.trim();
    if (!email) return;

    var evt = window._rcPopupEvent || {};
    var listKey = evt.zohoListKey || "";
    var source = evt.zohoSource || "Spinning Wheel";
    if (listKey) {
      fetch("/api/popup-submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: email, listKey: listKey, source: source }),
      }).catch(function () {});
    }

    // Switch to spinning state
    stepEmail.classList.add("hidden");
    stepSpinning.classList.remove("hidden");
    spinBtn.disabled = true;

    var winnerIndex = pickSegment();
    var segCenter = winnerIndex * segAngle + segAngle / 2;
    var totalRotation = 360 * 6 + (360 - segCenter);

    // Force reflow before applying transform
    void canvas.offsetWidth;
    canvas.style.transform = "rotate(" + totalRotation + "deg)";

    setTimeout(function () {
      stepSpinning.classList.add("hidden");
      stepPrize.classList.remove("hidden");

      var seg = segments[winnerIndex];
      if (seg.prize) {
        prizeHeadline.textContent = "Congratulations!";
        prizeBody.textContent = "You won: " + seg.label + "! Use this code at checkout:";
        prizeCode.textContent = seg.prize;
        prizeCodeWrap.classList.remove("hidden");
      } else {
        prizeHeadline.textContent = "So close!";
        prizeBody.textContent = "Better luck next time — we\u2019ve sent you something special by email!";
        prizeCodeWrap.classList.add("hidden");
      }
    }, 4300);
  });

  if (prizeCopy) {
    prizeCopy.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      var code = prizeCode.textContent.trim();
      navigator.clipboard.writeText(code).then(function () {
        prizeCopyLabel.textContent = "Copied!";
        setTimeout(function () { prizeCopyLabel.textContent = "Copy"; }, 2000);
      });
    });
  }

  window.addEventListener("rc:show-popup", function (e) {
    if (e.detail && e.detail.type === "spinning-wheel") {
      window._rcPopupEvent = e.detail;
      show();
    }
  });
})();
</script>
