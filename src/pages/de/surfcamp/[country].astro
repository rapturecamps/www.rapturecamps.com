---
/**
 * German country page — thin wrapper.
 * Once country documents are translated in Sanity, this page will serve German content.
 * Hardcoded country content (image grids, comparison tables) is shared with the English version for now.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import Hero from "@/components/sections/Hero.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import CTASection from "@/components/sections/CTASection.astro";
import BlockRenderer from "@/components/blocks/BlockRenderer.astro";
import { getCountries, getCountryBySlug, getCampsByCountry } from "@/lib/sanity-data";
import { t } from "@/lib/i18n";

const lang = "de";

export async function getStaticPaths() {
  const countries = await getCountries("de");
  return countries.map((c: any) => ({ params: { country: c.slug } }));
}

const { country } = Astro.params;
const countryData = await getCountryBySlug(country!, lang);
const camps = await getCampsByCountry(country!, lang);
const countryName = countryData?.name || country!.split("-").map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
const sanityPageBuilder = countryData?.pageBuilder || [];

const comparison = countryData?.comparison;
const hasComparison = comparison?.heading && comparison?.features?.length && comparison?.camps?.length;

const comparisonCamps = comparison?.camps?.map((c: any) => ({
  slug: `/de/surfcamp/${country}/${c.campSlug}`,
  values: c.values || [],
  campName: c.campName,
  campImage: c.campImage,
  campLocation: c.campLocation,
  campTagline: c.campTagline,
  campRating: c.campRating,
  campReviewCount: c.campReviewCount,
  campAmenities: c.campAmenities,
})) || [];

const amenityLabels: Record<string, string> = {
  "pool": "Pool",
  "surf-lessons": "Surfstunden",
  "yoga": "Yoga",
  "restaurant": "Mahlzeiten inkl.",
  "wifi": "WiFi",
  "bar": "Bar",
  "gym": "Gym",
  "bikes": "Fahrräder",
};
---

<BaseLayout
  title={countryData?.seo?.metaTitle || `Surfcamps in ${countryName} | Rapture Surfcamps`}
  description={countryData?.seo?.metaDescription || countryData?.description || `Entdecke Rapture Surfcamps in ${countryName}.`}
>
  <Hero
    title={countryData?.heroTitle || `Surfcamps\nin ${countryName}`}
    tagline={countryData?.heroTagline}
    subtitle={`Entdecke unsere Surfcamps in ${countryName}.`}
    backgroundImages={countryData?.heroImages}
  />

  <Breadcrumbs
    crumbs={[
      { label: "Surfcamps", href: "/de/surfcamp" },
      { label: countryName },
    ]}
  />

  {hasComparison ? (
    <section class="py-16 sm:py-20 bg-dark">
      <div class="px-6 sm:px-12 lg:px-20">
        <div class="mb-14">
          <h2 class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-white mb-4">{comparison.heading}</h2>
          {comparison.subtitle && <p class="text-base sm:text-lg text-white/50 max-w-3xl leading-relaxed">{comparison.subtitle}</p>}
        </div>

        {/* Desktop */}
        <div class={`hidden md:block ${comparisonCamps.length === 1 ? "max-w-2xl mx-auto" : ""}`}>
          <div class="grid gap-6 mb-6" style={`grid-template-columns: repeat(${comparisonCamps.length}, 1fr)`}>
            {comparisonCamps.map((compCamp: any) => {
              const lookup = camps?.find((d: any) => compCamp.slug.endsWith(d.slug?.split("/").pop()!));
              const name = compCamp.campName || lookup?.name;
              const image = compCamp.campImage || lookup?.image;
              const location = compCamp.campLocation || lookup?.location;
              const tagline = compCamp.campTagline || lookup?.tagline;
              const rating = compCamp.campRating ?? lookup?.rating;
              const reviewCount = compCamp.campReviewCount ?? lookup?.reviewCount;
              const amenities = compCamp.campAmenities || lookup?.amenities;
              const href = lookup ? `/de/surfcamp/${country}/${lookup.slug?.split("/").pop()}` : compCamp.slug;
              if (!name) return null;
              return (
                <a href={href} class="group overflow-hidden rounded-2xl bg-dark-lighter border border-white/5 transition-all hover:border-white/15">
                  <div class="relative aspect-[16/10] overflow-hidden">
                    <img src={image} alt={`${name} Surfcamp`} class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                    {rating && (
                      <div class="absolute top-4 left-4 flex items-center gap-1.5 bg-black/50 backdrop-blur-sm rounded-full px-3 py-1.5">
                        <svg class="h-3.5 w-3.5 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        <span class="text-white text-xs font-semibold">{rating}</span>
                        {reviewCount && <span class="text-white/50 text-[11px]">({reviewCount})</span>}
                      </div>
                    )}
                  </div>
                  <div class="p-5">
                    <p class="text-[11px] uppercase tracking-wider text-white/30 mb-1">{location}</p>
                    <h3 class="text-lg font-semibold text-white group-hover:text-ocean-light transition-colors">{name}</h3>
                    {tagline && <p class="text-sm text-white/45 mt-1 leading-snug">{tagline}</p>}
                    {amenities && amenities.length > 0 && (
                      <div class="mt-3 flex flex-wrap gap-1.5">
                        {amenities.map((a: string) => (
                          <span class="inline-flex items-center gap-1 text-[10px] text-white/40 bg-white/5 rounded-full px-2 py-0.5">
                            {amenityLabels[a] || a}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
          <div class="grid gap-6" style={`grid-template-columns: repeat(${comparisonCamps.length}, 1fr)`}>
            {comparisonCamps.map((camp: any) => (
              <div class="rounded-2xl border border-white/5 overflow-hidden">
                {comparison.features.map((feature: string, i: number) => (
                  <div class={`p-4 px-5 ${i % 2 === 0 ? "bg-dark-lighter/50" : "bg-dark"} ${i < comparison.features.length - 1 ? "border-b border-white/5" : ""}`}>
                    <span class="block text-[11px] uppercase tracking-wider text-white/30 mb-1">{feature}</span>
                    <span class="text-sm text-white/75">{camp.values[i]}</span>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>

        {/* Mobile */}
        <div class="md:hidden space-y-6">
          {comparisonCamps.map((compCamp: any) => {
            const lookup = camps?.find((d: any) => compCamp.slug.endsWith(d.slug?.split("/").pop()!));
            const name = compCamp.campName || lookup?.name;
            const image = compCamp.campImage || lookup?.image;
            const location = compCamp.campLocation || lookup?.location;
            const tagline = compCamp.campTagline || lookup?.tagline;
            const rating = compCamp.campRating ?? lookup?.rating;
            const reviewCount = compCamp.campReviewCount ?? lookup?.reviewCount;
            const amenities = compCamp.campAmenities || lookup?.amenities;
            const href = lookup ? `/de/surfcamp/${country}/${lookup.slug?.split("/").pop()}` : compCamp.slug;
            if (!name) return null;
            return (
              <a href={href} class="block overflow-hidden rounded-2xl bg-dark-lighter border border-white/5 transition-all hover:border-white/15 group">
                <div class="relative aspect-[16/10] overflow-hidden">
                  <img src={image} alt={`${name} Surfcamp`} class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" />
                  {rating && (
                    <div class="absolute top-4 left-4 flex items-center gap-1.5 bg-black/50 backdrop-blur-sm rounded-full px-3 py-1.5">
                      <svg class="h-3.5 w-3.5 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                      <span class="text-white text-xs font-semibold">{rating}</span>
                      {reviewCount && <span class="text-white/50 text-[11px]">({reviewCount})</span>}
                    </div>
                  )}
                </div>
                <div class="p-5">
                  <p class="text-[11px] uppercase tracking-wider text-white/30 mb-1">{location}</p>
                  <h3 class="text-lg font-semibold text-white group-hover:text-ocean-light transition-colors">{name}</h3>
                  {tagline && <p class="text-sm text-white/45 mt-1 leading-snug">{tagline}</p>}
                  {amenities && amenities.length > 0 && (
                    <div class="mt-3 flex flex-wrap gap-1.5">
                      {amenities.map((a: string) => (
                        <span class="inline-flex items-center gap-1 text-[10px] text-white/40 bg-white/5 rounded-full px-2 py-0.5">
                          {amenityLabels[a] || a}
                        </span>
                      ))}
                    </div>
                  )}
                  <div class="mt-4 pt-4 border-t border-white/5 space-y-2.5">
                    {comparison.features.map((feature: string, i: number) => (
                      <div class="flex justify-between items-start gap-4">
                        <span class="text-xs text-white/30 shrink-0">{feature}</span>
                        <span class="text-xs text-white/65 text-right">{compCamp.values[i]}</span>
                      </div>
                    ))}
                  </div>
                  <div class="mt-4 flex items-center gap-2 text-ocean-light text-xs font-medium">
                    <span>Camp ansehen</span>
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  ) : camps?.length > 0 && (
    <section class="py-16 sm:py-20 bg-dark">
      <div class="px-6 sm:px-12 lg:px-20">
        <h2 class="text-2xl sm:text-3xl font-semibold text-white mb-10">Unsere Camps in {countryName}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {camps.map((camp: any) => (
            <a href={`/de/surfcamp/${country}/${camp.slug?.replace?.(`/surfcamp/${country}/`, "") || camp.slug}`} class="group rounded-xl overflow-hidden border border-white/5 bg-dark-lighter hover:border-white/10 transition-colors">
              <div class="aspect-[16/10] overflow-hidden">
                <img
                  src={camp.image || "https://images.unsplash.com/photo-1502933691298-84fc14542831?w=600&h=400&fit=crop"}
                  alt={camp.name}
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="lazy"
                />
              </div>
              <div class="p-5">
                <h3 class="text-base font-semibold text-white group-hover:text-ocean-light transition-colors">{camp.name}</h3>
                <p class="text-sm text-white/40 mt-1">{camp.location || camp.tagline}</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  {sanityPageBuilder.length > 0 && (
    <BlockRenderer blocks={sanityPageBuilder} />
  )}

  <CTASection faqSlug={country} blogCategory={country} />
</BaseLayout>
