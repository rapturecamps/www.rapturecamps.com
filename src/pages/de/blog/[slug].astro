---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import CTASection from "@/components/sections/CTASection.astro";
import { sanityClient } from "@/lib/sanity";
import { ALL_BLOG_POSTS, BLOG_POST_BY_SLUG } from "@/lib/queries";
import { PortableText } from "astro-portabletext";
import PortableImage from "@/components/portable-text/PortableImage.astro";
import PortableBlock from "@/components/portable-text/PortableBlock.astro";

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(ALL_BLOG_POSTS, { lang: "de" });
  return posts.map((post: any) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = await sanityClient.fetch(BLOG_POST_BY_SLUG, { slug, lang: "de" });

if (!post) {
  return Astro.redirect("/de/blog");
}

function formatDate(dateStr: string) {
  return new Date(dateStr).toLocaleDateString("de-DE", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

const seoTitle = post.seo?.metaTitle || `${post.title} | Rapture Surfcamps`;
const seoDesc = post.seo?.metaDescription || post.excerpt || `Lies ${post.title} im Rapture Surfcamps Blog.`;
---

<BaseLayout
  title={seoTitle}
  description={seoDesc}
  ogImage={post.featuredImageUrl}
  translations={post._translations}
  translationBasePath="/blog"
>
  <div class="relative h-[55vh] min-h-[400px]">
    {post.featuredImageUrl && (
      <img
        src={post.featuredImageUrl + "?w=1920&h=1080&fit=crop&auto=format"}
        alt={post.title}
        class="absolute inset-0 h-full w-full object-cover"
      />
    )}
    <div class="absolute inset-0 bg-gradient-to-t from-dark via-dark/40 to-dark/50" />

    <div class="absolute bottom-0 left-0 right-0 pb-10 sm:pb-14">
      <div class="mx-auto max-w-3xl px-6 sm:px-8">
        {post.categories?.length > 0 && (
          <div class="flex gap-2 mb-4">
            {post.categories.map((cat: any) => (
              <a
                href={`/de/blog/category/${cat.slug}`}
                class="rounded-full bg-white/10 backdrop-blur-sm border border-white/10 px-3 py-1 text-[11px] font-medium text-white/80 hover:bg-white/20 transition-colors"
              >
                {cat.name}
              </a>
            ))}
          </div>
        )}
        <h1 class="font-display text-3xl md:text-4xl lg:text-5xl font-bold text-white leading-tight">
          {post.title}
        </h1>
        {post.publishedAt && (
          <time class="mt-3 block text-sm text-white/40">{formatDate(post.publishedAt)}</time>
        )}
        <Breadcrumbs inline crumbs={[
          { label: "Blog", href: "/de/blog" },
          { label: post.title },
        ]} />
      </div>
    </div>
  </div>

  <article class="py-16 sm:py-20 bg-dark">
    <div class="mx-auto max-w-3xl px-6 sm:px-8">
      <div class="blog-prose">
        {post.body ? (
          <PortableText value={post.body} components={{ type: {
            image: PortableImage,
            imageGrid: PortableBlock,
            imageBreak: PortableBlock,
            imageCarousel: PortableBlock,
            imageGallery: PortableBlock,
            videoBlock: PortableBlock,
            videoTestimonials: PortableBlock,
            highlightsGrid: PortableBlock,
            inclusionsGrid: PortableBlock,
            faqSection: PortableBlock,
            ctaSection: PortableBlock,
            contentBlock: PortableBlock,
          } }} />
        ) : (
          <p class="text-white/40">Dieser Beitrag hat noch keinen Inhalt.</p>
        )}
      </div>

      {post.tags?.length > 0 && (
        <div class="mt-16 pt-8 border-t border-white/10">
          <div class="flex flex-wrap gap-2">
            {post.tags.map((tag: string) => (
              <span class="rounded-full border border-white/10 px-3 py-1 text-[11px] text-white/40">
                {tag}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  </article>

  <CTASection />
</BaseLayout>

<style is:global>
  .blog-prose {
    font-size: 1.125rem;
    line-height: 1.8;
    color: rgba(255, 255, 255, 0.55);
  }

  .blog-prose h2 {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    margin-top: 3rem;
    margin-bottom: 1rem;
    line-height: 1.3;
    letter-spacing: -0.03em;
  }

  .blog-prose h3 {
    font-family: var(--font-display);
    font-size: 1.375rem;
    font-weight: 600;
    color: white;
    margin-top: 2.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.35;
    letter-spacing: -0.02em;
  }

  .blog-prose h4 {
    font-family: var(--font-display);
    font-size: 1.125rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85);
    margin-top: 2rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .blog-prose > :first-child {
    margin-top: 0;
  }

  .blog-prose p {
    margin-bottom: 1.5rem;
  }

  .blog-prose a {
    color: var(--color-ocean-light, #5dade2);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-color: rgba(93, 173, 226, 0.3);
    transition: color 0.15s, text-decoration-color 0.15s;
  }

  .blog-prose a:hover {
    color: white;
    text-decoration-color: white;
  }

  .blog-prose strong {
    color: rgba(255, 255, 255, 0.85);
    font-weight: 600;
  }

  .blog-prose em {
    color: rgba(255, 255, 255, 0.65);
  }

  .blog-prose ul {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .blog-prose ol {
    list-style-type: decimal;
    padding-left: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .blog-prose li {
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
  }

  .blog-prose li::marker {
    color: rgba(255, 255, 255, 0.25);
  }

  .blog-prose li ul,
  .blog-prose li ol {
    margin-top: 0.5rem;
    margin-bottom: 0;
  }

  .blog-prose blockquote {
    border-left: 3px solid var(--color-ocean-light, #5dade2);
    padding: 1rem 0 1rem 1.5rem;
    margin: 2rem 0;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
  }

  .blog-prose blockquote p {
    margin-bottom: 0;
  }

  .blog-prose hr {
    border: none;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin: 3rem 0;
  }

  .blog-prose code {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 4px;
    padding: 0.15em 0.4em;
    font-size: 0.875em;
  }

  .blog-prose pre {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 0.75rem;
    padding: 1.25rem 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
  }

  .blog-prose pre code {
    background: none;
    border: none;
    padding: 0;
    font-size: 0.875rem;
    line-height: 1.7;
  }

  .blog-prose .blog-block-breakout {
    width: 100vw;
    position: relative;
    left: 50%;
    margin-left: -50vw;
    margin-top: 3rem;
    margin-bottom: 3rem;
  }

  .blog-prose figure {
    margin: 2.5rem 0;
  }

  .blog-prose table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.9375rem;
  }

  .blog-prose th {
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 2px solid rgba(255, 255, 255, 0.15);
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
  }

  .blog-prose td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  @media (max-width: 640px) {
    .blog-prose {
      font-size: 1rem;
      line-height: 1.75;
    }

    .blog-prose h2 {
      font-size: 1.5rem;
      margin-top: 2.5rem;
    }

    .blog-prose h3 {
      font-size: 1.25rem;
      margin-top: 2rem;
    }
  }
</style>
