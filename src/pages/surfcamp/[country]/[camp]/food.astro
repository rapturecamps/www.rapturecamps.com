---
import CampLayout from "@/components/layout/CampLayout.astro";
import BlockRenderer from "@/components/blocks/BlockRenderer.astro";
import CTASection from "@/components/sections/CTASection.astro";
import { destinations } from "@/lib/data";
import { getDestinations, getCampBySlug, getCampFoodPage } from "@/lib/sanity-data";

export async function getStaticPaths() {
  const allCamps = await getDestinations();
  return allCamps.map((d) => {
    const parts = d.slug.replace("/surfcamp/", "").split("/");
    return { params: { country: parts[0], camp: parts[1] } };
  });
}

const { country, camp } = Astro.params;
const campData = await getCampBySlug(camp!) || destinations.find((d) => d.slug === `/surfcamp/${country}/${camp}`);
const foodPage = await getCampFoodPage(camp!);
const campTitle = foodPage?.campName || campData?.name || camp!.split("-").map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
const countryTitle = foodPage?.countryName || country!.split("-").map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
const bookingUrl = foodPage?.bookingUrl || campData?.bookingUrl || `https://bookings.rapturecamps.com/en/product/${country}-${camp}-surf-stay`;
const basePath = `/surfcamp/${country}/${camp}`;

const blocks = foodPage?.pageBuilder;
---

<CampLayout
  campName={campTitle}
  countryName={countryTitle}
  basePath={basePath}
  activePage="food"
  bookingUrl={bookingUrl}
  heroImages={foodPage?.heroImages || campData?.heroImages}
  heroTitle={foodPage?.heroTitle}
  title={foodPage?.seo?.metaTitle || `Food at ${campTitle} | Rapture Surfcamps`}
  description={foodPage?.seo?.metaDescription || `Discover the dining experience at Rapture Surf Camp ${campTitle}. Fresh, healthy meals prepared daily.`}
>
  {blocks?.length ? (
    <BlockRenderer blocks={blocks} campData={campData} />
  ) : (
    <CTASection />
  )}
</CampLayout>
