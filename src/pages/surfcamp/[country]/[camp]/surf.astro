---
import CampLayout from "@/components/layout/CampLayout.astro";
import BlockRenderer from "@/components/blocks/BlockRenderer.astro";
import CTASection from "@/components/sections/CTASection.astro";
import { destinations } from "@/lib/data";
import { getDestinations, getCampBySlug, getCampSurfPage } from "@/lib/sanity-data";

export async function getStaticPaths() {
  const allCamps = await getDestinations();
  return allCamps.map((d) => {
    const parts = d.slug.replace("/surfcamp/", "").split("/");
    return { params: { country: parts[0], camp: parts[1] } };
  });
}

const { country, camp } = Astro.params;
const campData = await getCampBySlug(camp!) || destinations.find((d) => d.slug === `/surfcamp/${country}/${camp}`);
const surfPage = await getCampSurfPage(camp!);
const campTitle = surfPage?.campName || campData?.name || camp!.split("-").map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
const countryTitle = surfPage?.countryName || country!.split("-").map((w) => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
const bookingUrl = surfPage?.bookingUrl || campData?.bookingUrl || `https://bookings.rapturecamps.com/en/product/${country}-${camp}-surf-stay`;
const basePath = `/surfcamp/${country}/${camp}`;

const blocks = surfPage?.pageBuilder;
---

<CampLayout
  campName={campTitle}
  countryName={countryTitle}
  basePath={basePath}
  activePage="surf"
  bookingUrl={bookingUrl}
  heroImages={surfPage?.heroImages || campData?.heroImages}
  heroTitle={surfPage?.heroTitle}
  title={`Surf at ${campTitle} | Rapture Surfcamps`}
  description={`Discover the surf spots, conditions, and lessons at Rapture Surf Camp ${campTitle} in ${countryTitle}.`}
>
  {blocks?.length ? (
    <BlockRenderer blocks={blocks} campData={campData} />
  ) : (
    <CTASection />
  )}

  <script is:inline>
  (function () {
    var card = document.querySelector(".surf-conditions-card");
    if (!card) return;
    var lat = card.getAttribute("data-lat");
    var lng = card.getAttribute("data-lng");
    if (!lat || !lng) return;

    var url = "https://marine-api.open-meteo.com/v1/marine"
      + "?latitude=" + lat
      + "&longitude=" + lng
      + "&current=wave_height,wave_period,wave_direction,swell_wave_height,swell_wave_period,swell_wave_direction"
      + "&daily=wave_height_max,wave_period_max,wave_direction_dominant,swell_wave_height_max,swell_wave_period_max,swell_wave_direction_dominant"
      + "&forecast_days=14&timezone=auto";

    var DAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function degToCompass(deg) {
      var dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function waveColor(h) {
      if (h == null) return { dot: "bg-white/20", bg: "border-white/5", text: "text-white/30" };
      if (h < 1.0) return { dot: "bg-green-400", bg: "border-green-500/20", text: "text-green-400" };
      if (h < 2.0) return { dot: "bg-ocean-light", bg: "border-ocean/30", text: "text-ocean-light" };
      return { dot: "bg-amber-400", bg: "border-amber-500/20", text: "text-amber-400" };
    }

    function updateCurrent(data) {
      var c = data.current;
      if (!c) return;
      var badge = card.querySelector(".surf-live-badge");
      if (badge) { badge.classList.remove("hidden"); badge.classList.add("flex"); }
      var wh = card.querySelector(".surf-live-wave-height");
      var wp = card.querySelector(".surf-live-wave-period");
      var sh = card.querySelector(".surf-live-swell-height");
      var sd = card.querySelector(".surf-live-swell-dir");
      if (wh && c.wave_height != null) wh.textContent = c.wave_height.toFixed(1) + " m";
      if (wp && c.wave_period != null) wp.textContent = c.wave_period.toFixed(0) + " s";
      if (sh && c.swell_wave_height != null) sh.textContent = c.swell_wave_height.toFixed(1) + " m";
      if (sd && c.swell_wave_direction != null) sd.textContent = degToCompass(c.swell_wave_direction) + " (" + Math.round(c.swell_wave_direction) + "°)";
    }

    function buildForecast(data) {
      var d = data.daily;
      if (!d || !d.time) return;
      var scroll = document.querySelector(".forecast-scroll");
      var placeholder = document.querySelector(".forecast-placeholder");
      var badge = document.querySelector(".forecast-live-badge");
      if (!scroll) return;
      if (placeholder) placeholder.remove();
      if (badge) { badge.classList.remove("hidden"); badge.classList.add("flex"); }
      var today = new Date(); today.setHours(0, 0, 0, 0);
      for (var i = 0; i < d.time.length; i++) {
        var wh = d.wave_height_max[i]; var wp = d.wave_period_max[i];
        var wd = d.wave_direction_dominant[i]; var sh = d.swell_wave_height_max[i];
        var sp = d.swell_wave_period_max[i]; var sd = d.swell_wave_direction_dominant[i];
        if (wh == null && sh == null) continue;
        var date = new Date(d.time[i] + "T00:00:00");
        var isToday = date.getTime() === today.getTime();
        var colors = waveColor(wh);
        var el = document.createElement("div");
        el.className = "flex-shrink-0 w-[140px] sm:w-[155px] rounded-xl border bg-dark p-4 snap-start transition-colors " + colors.bg;
        if (isToday) el.className += " ring-1 ring-ocean/30";
        var dayLabel = isToday ? "Today" : DAYS[date.getDay()];
        var dateLabel = date.getDate() + " " + MONTHS[date.getMonth()];
        var html = '<div class="flex items-center justify-between mb-3"><div><p class="text-xs font-semibold text-white">' + dayLabel + '</p><p class="text-[10px] text-white/30">' + dateLabel + '</p></div><span class="h-2.5 w-2.5 rounded-full ' + colors.dot + '"></span></div><div class="space-y-2.5">';
        if (wh != null) html += '<div><p class="text-[10px] text-white/25 uppercase tracking-wider">Waves</p><p class="text-lg font-semibold ' + colors.text + '">' + wh.toFixed(1) + ' <span class="text-xs font-normal text-white/30">m</span></p></div>';
        if (wp != null) html += '<div class="flex justify-between items-baseline"><span class="text-[10px] text-white/25">Period</span><span class="text-xs text-white/60 font-medium">' + Math.round(wp) + 's</span></div>';
        if (sh != null) html += '<div class="flex justify-between items-baseline"><span class="text-[10px] text-white/25">Swell</span><span class="text-xs text-white/60 font-medium">' + sh.toFixed(1) + 'm</span></div>';
        if (sd != null) html += '<div class="flex justify-between items-baseline"><span class="text-[10px] text-white/25">Direction</span><span class="text-xs text-white/60 font-medium">' + degToCompass(sd) + '</span></div>';
        html += '</div>'; el.innerHTML = html; scroll.appendChild(el);
      }
      scroll.addEventListener("scroll", function () {
        var fl = document.querySelector(".forecast-fade-left");
        if (fl) { if (scroll.scrollLeft > 10) fl.classList.remove("hidden"); else fl.classList.add("hidden"); }
      });
    }

    function fallback() {
      var wh = card.querySelector(".surf-live-wave-height");
      var wp = card.querySelector(".surf-live-wave-period");
      var sh = card.querySelector(".surf-live-swell-height");
      var sd = card.querySelector(".surf-live-swell-dir");
      if (wh && wh.textContent === "—") wh.textContent = "1.2 m";
      if (wp && wp.textContent === "—") wp.textContent = "10 s";
      if (sh && sh.textContent === "—") sh.textContent = "0.8 m";
      if (sd && sd.textContent === "—") sd.textContent = "SW";
      var placeholder = document.querySelector(".forecast-placeholder");
      if (placeholder) placeholder.innerHTML = '<p class="text-sm text-white/20">Forecast unavailable right now</p>';
    }

    var timeout = setTimeout(fallback, 6000);
    fetch(url)
      .then(function (r) { return r.json(); })
      .then(function (data) { clearTimeout(timeout); updateCurrent(data); buildForecast(data); })
      .catch(function () { clearTimeout(timeout); fallback(); });
  })();
  </script>

  <style>
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
  </style>
</CampLayout>
